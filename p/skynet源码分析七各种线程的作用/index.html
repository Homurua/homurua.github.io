<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ã€€skynet è¿›ç¨‹ä¸­ä¸€å…±æœ‰äº”ç§çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ã€monitor çº¿ç¨‹ã€timer çº¿ç¨‹ã€socket çº¿ç¨‹å’Œ worker çº¿ç¨‹ã€‚æ¯ç§çº¿ç¨‹å„å¸å…¶èŒï¼Œæœ¬ç¯‡ä¼šè®²è¿°ä¸€ä¸‹å„ç§çº¿ç¨‹çš„ä½œç”¨ã€‚
'><title>skynetæºç åˆ†æï¼ˆä¸ƒï¼‰å„ç§çº¿ç¨‹çš„ä½œç”¨</title>

<link rel='canonical' href='https://wmf.im/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%83%E5%90%84%E7%A7%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BD%9C%E7%94%A8/'>

<link rel="stylesheet" href="/scss/style.min.e2f1b0a7c117e0132d2bfedd61d7ce82c7bd6daae147284607d15b4402c78602.css"><meta property='og:title' content='skynetæºç åˆ†æï¼ˆä¸ƒï¼‰å„ç§çº¿ç¨‹çš„ä½œç”¨'>
<meta property='og:description' content='ã€€skynet è¿›ç¨‹ä¸­ä¸€å…±æœ‰äº”ç§çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ã€monitor çº¿ç¨‹ã€timer çº¿ç¨‹ã€socket çº¿ç¨‹å’Œ worker çº¿ç¨‹ã€‚æ¯ç§çº¿ç¨‹å„å¸å…¶èŒï¼Œæœ¬ç¯‡ä¼šè®²è¿°ä¸€ä¸‹å„ç§çº¿ç¨‹çš„ä½œç”¨ã€‚
'>
<meta property='og:url' content='https://wmf.im/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%83%E5%90%84%E7%A7%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BD%9C%E7%94%A8/'>
<meta property='og:site_name' content='æ”¾å­¦åèŒ¶ä¼š'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='skynet' /><meta property='article:published_time' content='2022-02-13T17:36:02&#43;08:00'/><meta property='article:modified_time' content='2022-02-13T17:36:02&#43;08:00'/>
<meta name="twitter:title" content="skynetæºç åˆ†æï¼ˆä¸ƒï¼‰å„ç§çº¿ç¨‹çš„ä½œç”¨">
<meta name="twitter:description" content="ã€€skynet è¿›ç¨‹ä¸­ä¸€å…±æœ‰äº”ç§çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ã€monitor çº¿ç¨‹ã€timer çº¿ç¨‹ã€socket çº¿ç¨‹å’Œ worker çº¿ç¨‹ã€‚æ¯ç§çº¿ç¨‹å„å¸å…¶èŒï¼Œæœ¬ç¯‡ä¼šè®²è¿°ä¸€ä¸‹å„ç§çº¿ç¨‹çš„ä½œç”¨ã€‚
">
    <link rel="shortcut icon" href="/img/dango.svg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar2_hu982b126fde96804c253e53a1f123b818_111741_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¡</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ”¾å­¦åèŒ¶ä¼š</a></h1>
            <h2 class="site-description">Please don&#39;t say &#34;You are lazy&#34;</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/medetasi'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E6%94%BE%E5%AD%A6%E5%90%8E%E8%8C%B6%E4%BC%9A/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/skynet%E7%AC%94%E8%AE%B0/" style="background-color: #46BDBA; color: #fff;">
                skynetç¬”è®°
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%83%E5%90%84%E7%A7%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BD%9C%E7%94%A8/">skynetæºç åˆ†æï¼ˆä¸ƒï¼‰å„ç§çº¿ç¨‹çš„ä½œç”¨</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 13, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 9 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p>ã€€ã€€skynet è¿›ç¨‹ä¸­ä¸€å…±æœ‰äº”ç§çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ã€monitor çº¿ç¨‹ã€timer çº¿ç¨‹ã€socket çº¿ç¨‹å’Œ worker çº¿ç¨‹ã€‚æ¯ç§çº¿ç¨‹å„å¸å…¶èŒï¼Œæœ¬ç¯‡ä¼šè®²è¿°ä¸€ä¸‹å„ç§çº¿ç¨‹çš„ä½œç”¨ã€‚</p>
<h2 id="ä¸»çº¿ç¨‹">ä¸»çº¿ç¨‹</h2>
<p>ã€€ã€€skynet ä¸­çš„ä¸»çº¿ç¨‹åªè´Ÿè´£è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œåœ¨å‰ç¯‡è®²å¯åŠ¨æµç¨‹çš„æ—¶å€™ï¼Œé‚£äº›æ“ä½œéƒ½æ˜¯å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ä¸­çš„ã€‚<br>
ã€€ã€€ä¸»çº¿ç¨‹ä¸å‚ä¸ä»»ä½•ä¸šåŠ¡çš„å¤„ç†ï¼Œåœ¨åˆå§‹åŒ–å®Œæ‰€æœ‰çš„å…¨å±€å˜é‡ä»¥åï¼Œå®ƒæŒ‰é…ç½®åˆ›å»ºå‡ºäº†å‰©ä¸‹çš„å››ç§çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨ <code>pthread_join</code> é˜»å¡è‡ªå·±ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚</p>
<h2 id="monitor-ç»“æ„">monitor ç»“æ„</h2>
<p>ã€€ã€€åœ¨ä»‹ç»å…¶ä½™çº¿ç¨‹ä¹‹å‰ï¼Œé¦–å…ˆè¦çœ‹ä¸€ä¸ªç»“æ„ä½“ monitorï¼Œå®ƒè·Ÿåé¢ä»‹ç»çš„ monitor çº¿ç¨‹åŒåï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯ monitor çº¿ç¨‹ä¸“ç”¨çš„æ•°æ®ï¼Œè€Œæ˜¯ç»™æ‰€æœ‰çº¿ç¨‹è°ƒåº¦ worker çº¿ç¨‹ä½¿ç”¨çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">monitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count</span><span class="p">;</span> <span class="c1">// worker çº¿ç¨‹çš„æ€»æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">skynet_monitor</span> <span class="o">**</span><span class="n">m</span><span class="p">;</span> <span class="c1">// å…¨éƒ¨ worker çº¿ç¨‹çš„ monitor æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_cond_t</span> <span class="n">cond</span><span class="p">;</span> <span class="c1">// ç»™ worker çº¿ç¨‹æŒ‚èµ·ç”¨çš„å…¨å±€æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span> <span class="c1">// æœ‰é”ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sleep</span><span class="p">;</span> <span class="c1">// ç¡çœ çš„ worker çº¿ç¨‹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">quit</span><span class="p">;</span> <span class="c1">// é€€å‡ºæ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€monitor ç»“æ„ä½“å˜é‡æ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªæœ‰é”çš„ç»“æ„ï¼Œè¿™é‡Œå¯ä»¥å‘ç°ä¸€ä¸ªä¸å…¶å®ƒåœ°æ–¹æ˜æ˜¾çš„åŒºåˆ«ï¼Œé”ç›´æ¥ä½¿ç”¨äº† pthread åº“çš„ mutex æ¥åšï¼Œè€Œæ²¡æœ‰ç”¨ skynet ä¸­æ›´å¸¸ç”¨çš„ spinlock æ¥å®ç°ï¼Œä¸»è¦æ˜¯å› ä¸ºè¦é…åˆ cond æ¥åšçº¿ç¨‹æŒ‚èµ·ã€‚</p>
<h2 id="monitor-çº¿ç¨‹">monitor çº¿ç¨‹</h2>
<h3 id="ä½œç”¨">ä½œç”¨</h3>
<p>ã€€ã€€æ¯ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä»¥ä¸€ä¸ª monitor çº¿ç¨‹ï¼Œå®ƒçš„åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œmonitor é¡¾åæ€ä¹‰å°±æ˜¯ç›‘æ§ï¼Œå®ƒç›‘æ§çš„å°±æ˜¯æ‰€æœ‰ worker çº¿ç¨‹çš„å·¥ä½œçŠ¶æ€ï¼Œå¦‚æœ worker çº¿ç¨‹åœ¨å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ç”¨æ—¶å¤ªä¹…äº†ï¼Œmonitor çº¿ç¨‹ä¼šæ‰“å°å‡ºä¸€æ¡é”™è¯¯æ—¥å¿—ï¼Œå‘Šè¯‰å¼€å‘è€…ä¸€æ¡ä» A æœåŠ¡åˆ° B æœåŠ¡çš„æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ä¸­å¯èƒ½æœ‰æ­»å¾ªç¯å­˜åœ¨ã€‚</p>
<h3 id="å®ç°">å®ç°</h3>
<p>ã€€ã€€æ¥çœ‹ä¸€ä¸‹ monitor çº¿ç¨‹çš„ä¸»å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">thread_monitor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">monitor</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="c1">// æ‹¿åˆ° worker çº¿ç¨‹çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®çº¿ç¨‹å±æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">skynet_initthread</span><span class="p">(</span><span class="n">THREAD_MONITOR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_ABORT</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// éå†å…¨éƒ¨çš„çº¿ç¨‹ monitor è¿›è¡Œæ£€æŸ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">skynet_monitor_check</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç¡çœ  5s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½¿ç”¨å¾ªç¯åˆ†å¼€è°ƒç”¨æ˜¯ä¸ºäº†æ›´å¿«çš„è§¦å‘ abort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CHECK_ABORT</span>
</span></span><span class="line"><span class="cl">            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€çº¿ç¨‹ä¼šè¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ï¼Œå®ƒæ¯ 5s å¯¹æ¯ä¸ª worker çº¿ç¨‹çš„ <code>skynet_monitor</code> æ‰§è¡Œäº† <code>skynet_monitor_check</code> æ“ä½œã€‚<br>
ã€€ã€€æ¯ä¸ª worker çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„ skynet_monitor çš„å˜é‡ï¼Œå®ƒæ­£æ˜¯è¢«ä¿å­˜åœ¨äº†ä¸Šæ–‡æåˆ°çš„ struct monitor ä¸­ï¼Œå®ƒè´Ÿè´£è®°å½•æœ¬ worker çº¿ç¨‹çš„æ£€æŸ¥çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">skynet_monitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ATOM_INT</span> <span class="n">version</span><span class="p">;</span> <span class="c1">// åŸå­ version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">check_version</span><span class="p">;</span> <span class="c1">// ä¸Šæ¬¡æ£€æŸ¥æ—¶çš„ version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">source</span><span class="p">;</span> <span class="c1">// å½“å‰å¤„ç†çš„æ¶ˆæ¯çš„æº handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">destination</span><span class="p">;</span> <span class="c1">// å½“å‰å¤„ç†çš„æ¶ˆæ¯çš„ç›®æ ‡ handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€æ¯æ¬¡å½“ worker çº¿ç¨‹å¼€å§‹å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¼šä¿®æ”¹è‡ªå·±å¯¹åº”çš„ skynet_monitor ä¸­å˜é‡çš„å€¼ã€‚å…¶ä¸­ version ä¼šè¢«ä¸€ç›´ç´¯åŠ ï¼Œå¹¶ä¸”å°† source å’Œ destination è®¾ä¸ºå½“å‰å¤„ç†çš„æ¶ˆæ¯çš„æºåœ°å€å’Œç›®æ ‡åœ°å€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">skynet_monitor_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">skynet_monitor</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜è¿˜åœ¨å¤„ç†ä¸Šæ¬¡æ£€æŸ¥çš„é‚£æ¡æ¶ˆæ¯ï¼Œç»™å‡ºè­¦å‘Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">check_version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è®¾ç½® endless æ ‡ç­¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skynet_context_endless</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">destination</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skynet_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;A message from [ :%08x ] to [ :%08x ] maybe in an endless loop (version = %d)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">sm</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">destination</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœä¸ç›¸ç­‰ï¼Œè¿™ä¿å­˜æœ¬æ¬¡æ£€æŸ¥çš„ version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sm</span><span class="o">-&gt;</span><span class="n">check_version</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€<code>skynet_monitor_check</code> ä¸­çš„æ“ä½œä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ£€æŸ¥ <code>skynet_monitor</code> ä¸­çš„ <code>vesion</code> å’Œ <code>check_version</code> æ˜¯å¦ä¸€è‡´ã€‚å¦‚æœ version å’Œ check_version ä¸ç›¸ç­‰ï¼Œåˆ™æŠŠ check_version è®¾ä¸º versionï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™è¯´æ˜ä»ä¸Šæ¬¡æ£€æŸ¥åˆ°è¿™æ¬¡æ£€æŸ¥ä¹Ÿå°±æ˜¯ 5s ä¹‹å†…ï¼Œworker çº¿ç¨‹éƒ½åœ¨å¤„ç†åŒä¸€æ¡æ¶ˆæ¯ã€‚è¿™æ—¶å€™å°±è®¤ä¸ºè¿™ä¸ª worker çº¿ç¨‹å¯èƒ½å·²ç»é™·å…¥äº†æ­»å¾ªç¯ä¸­ã€‚æŠŠç›®æ ‡æœåŠ¡çš„ endless å±æ€§è®¾ä¸º trueï¼Œç„¶åè¾“å‡ºä¸€æ¡é”™è¯¯æ—¥å¿—è­¦å‘Šå¼€å‘è€…ã€‚<br>
ã€€ã€€é€šè¿‡é˜…è¯»å®ç°å¯ä»¥å‘ç°ï¼Œmonitor çº¿ç¨‹åªèƒ½èµ·åˆ°éå¸¸å¾®å¼±çš„è¾…åŠ©ä½œç”¨ï¼Œé‚£å°±æ˜¯å¦‚æœä¸€æ¡æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡ 5sï¼Œå°±å‘å‡ºä¸€æ¬¡è­¦å‘Šã€‚</p>
<h2 id="timer-çº¿ç¨‹">timer çº¿ç¨‹</h2>
<h3 id="ä½œç”¨-1">ä½œç”¨</h3>
<p>ã€€ã€€timer çº¿ç¨‹ä¸»è¦è´Ÿè´£äº†ä¸¤ä»¶äº‹æƒ…ï¼Œæ›´æ–°ç³»ç»Ÿçš„å½“å‰æ—¶é—´å’Œå”¤é†’ä¸€ä¸ªç¡çœ çš„ worker çº¿ç¨‹ã€‚å‰è€…æ˜¯ä¸ºäº†ç»™æ—¶é—´çš„è·å–æ¥å£æä¾›æ—¶é—´è¿”å›å€¼ï¼Œä»¥åŠæ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œåè€…æ˜¯è®©ä¹‹å‰å› ä¸ºæ²¡æœ‰å–åˆ°æ¶ˆæ¯å¤„ç†è€Œç¡çœ çš„ worker çº¿ç¨‹å†æ¬¡å°è¯•å»å¤„ç†æ¶ˆæ¯ã€‚</p>
<h3 id="è‡ªå·±è®¡æ—¶çš„æ„ä¹‰">è‡ªå·±è®¡æ—¶çš„æ„ä¹‰</h3>
<p>ã€€ã€€è®¡æ—¶çš„å®ç°å¾ˆç®€å•ï¼Œè®°å½•äº†ä¸€ä¸ªè¿›ç¨‹çš„å¼€å§‹æ—¶é—´ starttime å’Œä¸€ä¸ªè¿›ç¨‹ä»å¼€å§‹åˆ°ç°åœ¨ç»è¿‡çš„æ—¶é—´ current æ¥å®Œæˆå½“å‰æ—¶é—´çš„è®¡ç®—ï¼Œæ¯ç»è¿‡ 2.5ms å°† current çš„å€¼æ›´æ–°ä¸€æ¬¡ã€‚<br>
ã€€ã€€ä¹‹æ‰€ä»¥è¦æ¡†æ¶è‡ªå·±å®ç°è®¡æ—¶çš„åŸå› ä¸»è¦æœ‰ä¸¤ä¸ªã€‚é¦–å…ˆï¼Œå¯ä»¥ä¸ºä¸šåŠ¡å±‚å–é«˜ç²¾åº¦æ—¶é—´æä¾›ä¸€ä¸ªé«˜æ•ˆçš„è¿‘ä¼¼æ¥å£ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»è°ƒç”¨ <code>clock_gettime</code> å–ï¼Œæé«˜äº†æ€§èƒ½ã€‚ç¬¬äºŒä¸ªåŸå› æ˜¯è‡ªå·±å®ç°çš„è®¡æ—¶ä¸ä¼šè¢«ç³»ç»Ÿæ—¶é—´å½±å“ï¼Œåœ¨è¿›ç¨‹æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¦‚æœç³»ç»Ÿæ—¶é—´è¢«æ”¹æ‰äº†ï¼Œè‡ªå·±å®ç°çš„è®¡æ—¶å™¨è¿˜æ˜¯ä¼šæŒ‰ä»¥å‰çš„æ­¥éª¤æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸€äº›é—®é¢˜çš„å‘ç”Ÿï¼Œæ¯”å¦‚å®šæ—¶å™¨çš„è§¦å‘é—®é¢˜ã€‚</p>
<h3 id="æ—¶é—´æ¥å£çš„ä½¿ç”¨">æ—¶é—´æ¥å£çš„ä½¿ç”¨</h3>
<p>ã€€ã€€åœ¨ skynet ä¸­æœ‰å››ä¸ªæ—¶é—´æ¥å£ï¼Œ<code>skynet.now</code>ï¼Œ<code>skynet.time</code>ï¼Œ<code>skynet.hpc</code> è¿˜æœ‰ Lua å®˜æ–¹æä¾›çš„ <code>os.time</code>ï¼Œè¦æ ¹æ®åœºæ™¯ä½¿ç”¨ä¸åŒçš„æ¥å£ã€‚</p>
<ul>
<li><code>skynet.now</code> ç›´æ¥è¿”å›äº† <code>current</code> çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹å¯åŠ¨åˆ°ç°åœ¨çš„æ—¶é—´ï¼Œè¿™æ˜¯ä¸ªè¿‘ä¼¼æ¥å£ï¼Œ<code>current</code> çš„æ›´æ–°ç”± timer çº¿ç¨‹ç»´æŠ¤ï¼Œç²¾åº¦ä¸º 2.5msã€‚</li>
<li><code>skynet.time</code> è¿”å›äº† <code>current</code> + <code>starttime</code> çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„ç»å¯¹æ—¶é—´ï¼Œå®ƒçš„ç²¾åº¦åŒæ ·ä¸º 2.5msã€‚</li>
<li><code>skynet.hpc</code> åˆ™ç›´æ¥è°ƒç”¨äº† <code>clock_gettime</code> æ‹¿å–äº†è¿›ç¨‹å¯åŠ¨çš„ç›¸å¯¹çº³ç§’æ—¶é—´ï¼Œè¿™ä¸ªæ˜¯å‡†ç¡®çš„æ—¶é—´ï¼Œä½†æ˜¯æ¶ˆè€—æ˜¯æœ€å¤§çš„ã€‚</li>
<li><code>os.time</code> æ¥å£æ˜¯ç›´æ¥è°ƒç”¨äº† <code>time</code> çš„ï¼Œå®ƒè¿”å›çš„æ˜¯ç§’çº§çš„ç»å¯¹æ—¶é—´ï¼Œæ˜¯æœ€å¿«çš„ã€‚</li>
</ul>
<h3 id="å®šæ—¶å™¨çš„å®ç°">å®šæ—¶å™¨çš„å®ç°</h3>
<p>ã€€ã€€skynet ä¸­å®šæ—¶å™¨çš„è®¡æ—¶æ˜¯ä½¿ç”¨æ—¶é—´è½®ç®—æ³•æ¥å®ç°çš„ï¼Œæ—¶é—´è½®æ˜¯ä¸€ä¸ªè¢«å¹¿æ³›ç”¨äºå®ç°é«˜æ•ˆç‡å®šæ—¶å™¨çš„ç®—æ³•ï¼Œlinux kernel çš„å®šæ—¶å™¨ä¹Ÿæ˜¯ä½¿ç”¨æ—¶é—´è½®ç®—æ³•å®ç°çš„ã€‚<br>
ã€€ã€€skynet.timeout æ˜¯ skynet æä¾›çš„å®šæ—¶è°ƒç”¨æ¥å£ï¼Œå®ƒé¦–å…ˆæ‹¿åˆ°ä¸€ä¸ªæ–°çš„ session ç”¨äºæ¥æ”¶å®šæ—¶å™¨çš„å”¤é†’ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…è£¹äº†ç­‰å¾…æ‰§è¡Œçš„å‡½æ•°çš„åç¨‹ï¼ŒæŠŠåç¨‹è·Ÿ session å…³è”èµ·æ¥ï¼Œç„¶åç”¨ session å’Œè‡ªå·±çš„ handle åˆ›å»ºä¸€ä¸ª struct timer_event åŠ å…¥åˆ°æ—¶é—´è½®ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">timer_event</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€ç­‰å¾…æ—¶é—´è½®è½¬åŠ¨åˆ°äº†æŒ‡å®šçš„æ—¶é—´ç‚¹ä»¥åï¼Œä»é‡Œé¢å–å‡ºè¿™ä¸ª timer_event ç»“æ„ä½“å˜é‡ï¼Œä½¿ç”¨å…¶ä¸­çš„ session æ¥åˆ›å»ºä¸€æ¡ PTYPE_RESPONSE ç±»å‹çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯ push åˆ°ç›®æ ‡ handle çš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œã€‚ç­‰ worker çº¿ç¨‹å¤„ç†è¿™æ¡æ¶ˆæ¯æ—¶ï¼Œæ ¹æ® session æ‹¿åˆ°å¯¹åº”çš„ co æ‰§è¡Œå®ƒï¼Œä¸€ä¸ªå®šæ—¶å™¨çš„è°ƒç”¨å°±å®Œæˆäº†ã€‚</p>
<h2 id="socket-çº¿ç¨‹">socket çº¿ç¨‹</h2>
<h3 id="ä½œç”¨-2">ä½œç”¨</h3>
<p>ã€€ã€€socket çº¿ç¨‹ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼Œæ¥æ”¶å¹¶ä¸”å¤„ç† socket å‘½ä»¤ï¼Œå¤„ç† epoll äº‹ä»¶ï¼Œç„¶åå¦‚æœå½“å‰å…¨éƒ¨çš„ worker çº¿ç¨‹éƒ½åœ¨ç¡çœ ä¸­ï¼Œåˆ™å”¤é†’å…¶ä¸­çš„ä¸€ä¸ªã€‚<br>
ã€€ã€€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬çº¿ç¨‹å¹¶ä¸ä¼šå»æ‰§è¡Œä»»ä½• epoll äº‹ä»¶ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½æ˜¯è½¬æ¢æˆä¸€æ¡ PTYPE_SOCKET ç±»å‹çš„æ¶ˆæ¯ï¼Œå‘é€ç»™ä¸ç›¸å…³ socket ç»‘å®šçš„æœåŠ¡ã€‚<br>
ã€€ã€€socket çº¿ç¨‹çš„å…·ä½“å®ç°æ¯”è¾ƒå¤æ‚ï¼Œåé¢ä¼šä¸“é—¨å¼€ä¸€ç¯‡ç½‘ç»œä¸“æ–‡ï¼Œæ­¤å¤„åªå¤§æ¦‚è®²ä¸€ä¸‹ä½œç”¨ï¼Œå…·ä½“å®ç°æš‚æ—¶ç•¥è¿‡ã€‚</p>
<h2 id="worker-çº¿ç¨‹">worker çº¿ç¨‹</h2>
<h3 id="ä½œç”¨-3">ä½œç”¨</h3>
<p>ã€€ã€€worker çº¿ç¨‹é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¤„ç†é€»è¾‘çš„ä¸»åŠ›çº¿ç¨‹äº†ã€‚å®ƒåªåšä¸€ä»¶äº‹æƒ…ï¼Œå¤„ç†æ¶ˆæ¯ã€‚å®ƒä¼šå°è¯•å»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿åˆ°ä¸€ä¸ªæœåŠ¡é˜Ÿåˆ—ï¼Œç„¶åå†æ ¹æ®è‡ªå·±çš„è´Ÿè½½å‚æ•°ï¼Œå¤„ç†å…¶ä¸­ä¸€å®šæ¯”ä¾‹çš„æ¶ˆæ¯ã€‚å¦‚æœæ‹¿ä¸åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¼šæŠŠè‡ªå·±æŠ•å…¥ç¡çœ ä¸­ï¼Œç­‰å¾… timer çº¿ç¨‹æˆ–æ˜¯ socket çº¿ç¨‹å”¤é†’è‡ªå·±ã€‚</p>
<h3 id="æ•°é‡">æ•°é‡</h3>
<p>ã€€ã€€worker çº¿ç¨‹æ˜¯è¿™å‡ ç±»çº¿ç¨‹ä¸­å”¯ä¸€å¯ä»¥é€šè¿‡ config ä¸­çš„é…ç½®å‚æ•°ä¿®æ”¹çº¿ç¨‹æ•°é‡çš„ã€‚ä¸€èˆ¬æŠŠ worker çº¿ç¨‹çš„æ•°é‡è®¾ç½®ä¸ºæœ¬æœºçš„ cpu æ ¸å¿ƒæ•°å³å¯ã€‚</p>
<h3 id="å·¥ä½œå‚æ•°">å·¥ä½œå‚æ•°</h3>
<p>ã€€ã€€æ¯ä¸ª worker çº¿ç¨‹æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„å‚æ•°ç»“æ„ä½“ worker_parmï¼Œç”¨æ¥ä¿å­˜ä¸€äº›æœ¬çº¿ç¨‹çš„å‚æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">worker_parm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">monitor</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span> <span class="c1">// å…¨å±€ monitor çš„å¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span> <span class="c1">// çº¿ç¨‹ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">weight</span><span class="p">;</span> <span class="c1">// å·¥ä½œæƒé‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€å…¶ä¸­ weight è¡¨ç¤ºçš„æ˜¯å·¥ä½œæƒé‡ï¼Œç›®çš„æ˜¯ä¸ºäº†å°½é‡è®©ä¸åŒçš„ worker çº¿ç¨‹çš„æ­¥éª¤ä¸ä¸€æ ·ï¼Œä»è€Œå‡è½»åœ¨å…¨å±€æ¶ˆæ¯é˜Ÿåˆ—é‚£é‡Œçš„é”ç«äº‰é—®é¢˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">weight</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€worker çº¿ç¨‹åœ¨æ‹¿åˆ°æœåŠ¡çš„æ¶ˆæ¯é˜Ÿåˆ—ä»¥åï¼Œä¼šæŠŠé˜Ÿåˆ—é•¿åº¦ n &raquo;= weight æ¥å¾—åˆ°æœ¬æ¬¡è¦å¤„ç†çš„æ¶ˆæ¯æ•°é‡ã€‚æ‰€ä»¥å‰å››ä¸ªçº¿ç¨‹æ¯æ¬¡åªå¤„ç†ä¸€æ¡æ¶ˆæ¯ï¼Œåé¢çš„å››ä¸ªæ¯æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨æ¶ˆæ¯ï¼Œå†åé¢åˆ†åˆ«æ˜¯æ¯æ¬¡å¤„ç†æ€»é•¿åº¦çš„ 1/2ï¼Œ1/4ï¼Œ1/8 æ¡æ¶ˆæ¯ï¼Œ32 ä»¥åçš„ worker çº¿ç¨‹çš„ weight ä¸€å¾‹ä¸º 0ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨æ¶ˆæ¯ã€‚</p>
<h3 id="å®ç°-1">å®ç°</h3>
<p>ã€€ã€€ç…§ä¾‹å…ˆæ¥çœ‹ä¸€ä¸‹ worker çº¿ç¨‹çš„ä¸»å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">thread_worker</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">worker_parm</span> <span class="o">*</span><span class="n">wp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">monitor</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">skynet_monitor</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">skynet_initthread</span><span class="p">(</span><span class="n">THREAD_WORKER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">message_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">skynet_context_message_dispatch</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">weight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœ q æ˜¯ NULL çš„è¯ï¼Œè¯´æ˜æ²¡æœ‰ pop åˆ°è¦å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¦æŠŠå®ƒæŠ•å…¥åˆ°ç¡çœ ä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è·å–å…¨å±€ monitor çš„é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ç´¯åŠ å½“å‰ç¡çœ çš„çº¿ç¨‹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">++</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// &#34;spurious wakeup&#34; is harmless,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// because skynet_context_message_dispatch() can be call at any time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// ç­‰å¾…åœ¨æ¡ä»¶ä¸Šï¼Œé‡Šæ”¾ mutex, ç­‰å¾… socket çº¿ç¨‹æˆ–æ˜¯ timer çº¿ç¨‹å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è¢«å”¤é†’åå‡å°‘ç¡çœ çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">--</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é‡Šæ”¾é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;unlock mutex error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€åœ¨ä¸»å‡½æ•°ä¸­ï¼Œä¼šä¸æ–­è°ƒç”¨ <code>skynet_context_message_dispatch</code>ï¼Œå½“å®ƒçš„è¿”å›å€¼ q ä¸ä¸º NULL æ—¶ï¼Œè¯´æ˜è¿˜æœ‰æ¶ˆæ¯æœªå¤„ç†å®Œæ¯•ï¼Œå®ƒä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œå¹¶ä¸” q ä¼šè¢«å½“ä½œå‚æ•°é‡æ–°ä¼ ç»™å®ƒã€‚å¦‚æœ q ä¸º NULLï¼Œåˆ™è¯´æ˜å½“å‰å…¨å±€é˜Ÿåˆ—çš„æ¶ˆæ¯å·²ç»å¤„ç†å®Œæ¯•äº†ï¼Œworker çº¿ç¨‹ä¼šé˜»å¡åœ¨ cond ä¸Šï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å”¤é†’å®ƒã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">message_queue</span> <span class="o">*</span><span class="nf">skynet_context_message_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">skynet_monitor</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">message_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">weight</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">skynet_globalmq_pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‹¿åˆ°æœåŠ¡æ¶ˆæ¯é˜Ÿåˆ—çš„ handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">skynet_mq_handle</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„ handle å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">skynet_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">skynet_handle_grab</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ‹¿ä¸åˆ°å¯¹åº”çš„æœåŠ¡ï¼Œè¯´æ˜è¿™æ¶ˆæ¯é˜Ÿåˆ—è¢«åºŸå¼ƒäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">drop_t</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">handle</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">skynet_mq_release</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">drop_message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">skynet_globalmq_pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">skynet_message</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">skynet_mq_pop</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// æ‹¿ä¸åˆ°æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skynet_context_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">skynet_globalmq_pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ¶ˆæ¯é˜Ÿåˆ—çš„æ€»é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">n</span> <span class="o">=</span> <span class="n">skynet_mq_length</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æŒ‰çº¿ç¨‹å·¥ä½œæƒé‡æ‹¿æœ¬æ¬¡è¦å¤„ç†çš„æ¶ˆæ¯æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="n">weight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">overload</span> <span class="o">=</span> <span class="n">skynet_mq_overload</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">overload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">skynet_error</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;May overload, message queue length = %d&#34;</span><span class="p">,</span> <span class="n">overload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ›´æ–° monitor çš„è®°å½•å’Œè®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skynet_monitor_trigger</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">skynet_free</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¤„ç†æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">dispatch_message</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ›´æ–° monitor çš„è®°å½•å’Œè®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skynet_monitor_trigger</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">message_queue</span> <span class="o">*</span><span class="n">nq</span> <span class="o">=</span> <span class="n">skynet_globalmq_pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nq</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå…¨å±€é˜Ÿåˆ—æ˜¯éç©ºçš„ï¼Œä¼šå°† q push å›å…¨å±€é˜Ÿåˆ—çš„æœ€åï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸º q çš„æ¶ˆæ¯å¹¶ä¸ä¸€å®šè¢«å¤„ç†å®Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å…¨å±€é˜Ÿåˆ—å·²ç»ç©ºäº†çš„æ—¶å€™ï¼Œä¼šç»§ç»­è¿”å› qï¼Œä¸‹ä¸€æ¬¡è¿˜ä¼šå¤„ç† qï¼Œç›´åˆ° q ä¸­æ²¡æœ‰äº†æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// If global mq is not empty , push q back, and return next queue (nq)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Else (global mq is empty or block, don&#39;t push q back, and return q again (for next dispatch)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">skynet_globalmq_push</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">nq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">skynet_context_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€é€šè¿‡è°ƒç”¨ skynet_globalmq_pop ä»å…¨å±€é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæœåŠ¡é˜Ÿåˆ—ï¼Œå…¨å±€é˜Ÿåˆ—æ˜¯ä¸ªé“¾è¡¨ï¼Œæ­¤å¤„åŠ é”ä»¥åï¼Œä»é“¾è¡¨å¤´éƒ¨å–å‡ºå³å¯ã€‚<br>
ã€€ã€€æ‹¿åˆ°æœåŠ¡æ¶ˆæ¯é˜Ÿåˆ—ä»¥åï¼Œéœ€è¦ä»é‡Œé¢æ‹¿å–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œå¾ªç¯çš„æ¬¡æ•°è·Ÿæœ¬çº¿ç¨‹çš„å·¥ä½œæƒé‡ weight æœ‰å…³ï¼Œé€šè¿‡è®¡ç®—å½“å‰é˜Ÿåˆ—ä¸­å¾…å¤„ç†çš„æ¶ˆæ¯æ€»é•¿åº¦ n &raquo;= weight å¾—åˆ°æœ¬æ¬¡è¦å¤„ç†çš„æ¶ˆæ¯æ¡æ•°ã€‚<br>
ã€€ã€€dispatch_message ç”¨æ¥å¤„ç†æ¶ˆæ¯ï¼Œé€šè¿‡ç§»ä½æ‹¿åˆ°æ¶ˆæ¯çš„ç±»å‹å’Œé•¿åº¦ï¼Œç´¯åŠ å¤„ç†æ¶ˆæ¯è®¡æ•°ï¼Œç„¶åè°ƒç”¨ context çš„ callback å‡½æ•°è¿›è¡Œå¤„ç†ã€‚<br>
ã€€ã€€æœ¬è½®æ¶ˆæ¯å¤„ç†å®Œæ¯•ä»¥åï¼Œä¼šå°è¯•è·å–ä¸€ä¸ªæ–°çš„æœåŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœèƒ½æ‹¿åˆ°ï¼Œä¸ç®¡å½“å‰å¤„ç†çš„é˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰å‰©ä½™æ¶ˆæ¯ï¼Œéƒ½ä¼šæŠŠå½“å‰é˜Ÿåˆ— push åˆ°å…¨å±€é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå¦‚æœæ‹¿ä¸åˆ°æ–°çš„é˜Ÿåˆ—ï¼Œåˆ™ç»§ç»­å¤„ç†æœ¬é˜Ÿåˆ—ï¼Œå³ä½¿å®ƒå…¶ä¸­å·²ç»æ²¡æœ‰æ¶ˆæ¯äº†ï¼Œä¼šåœ¨ä¸‹ä¸€æ¬¡æ£€æŸ¥æ¶ˆæ¯é•¿åº¦çš„æ—¶å€™ç›´æ¥è¿”å›ã€‚<br>
ã€€ã€€å¦‚æœä¸€å¼€å§‹æ‹¿åˆ°çš„è¦å¤„ç†çš„æœåŠ¡é˜Ÿåˆ—ä¸­æœ¬æ¥å°±æ²¡æœ‰æ¶ˆæ¯çš„è¯ï¼Œåˆ™ä¼šæŠŠå…¶ in_global å‚æ•°è®¾ä¸º 0ï¼Œä¸”ä¸ä¼šå°†å…¶æ”¾å›å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯ä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—ä¸­å†æ‹¿å–ä¸€ä¸ªé˜Ÿåˆ—è¿”å›ï¼Œæ¥è¿›è¡Œä¸‹ä¸€æ¬¡çš„å¤„ç†ã€‚è¿™ä¸ªæ²¡æœ‰æ¶ˆæ¯ä¹Ÿæ²¡æœ‰åœ¨å…¨å±€é˜Ÿåˆ—ä¸­çš„æœåŠ¡é˜Ÿåˆ—ä¼šä¸€ç›´ä¿æŒè¿™ä¸ªçŠ¶æ€ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æœ‰å…¶å®ƒæœåŠ¡å‘å…¶å‘é€æ¶ˆæ¯ï¼Œè¿™æ—¶å€™ä¼šé‡æ–°æŠŠå…¶ in_global å‚æ•°è®¾ä¸º MQ_IN_GLOBALï¼Œå¹¶æŠŠå…¶ push å›å…¨å±€é˜Ÿåˆ—ä¸­ã€‚<br>
ã€€ã€€å½“ worker çº¿ç¨‹å·²ç»ä»å…¨å±€é˜Ÿåˆ—ä¸­å–ä¸åˆ°æœåŠ¡é˜Ÿåˆ—æ—¶ï¼Œå®ƒä¼šé”ä¸Š monitor ç»“æ„çš„é”ï¼Œç„¶åç´¯åŠ ä¼‘çœ çš„çº¿ç¨‹æ•° sleepï¼Œå¹¶ä¸”ä½¿ç”¨ pthread_cond_wait å°†çº¿ç¨‹é˜»å¡åœ¨ monitor.cond ä¸Šï¼Œç­‰å¾… socket çº¿ç¨‹æˆ–æ˜¯ timer çº¿ç¨‹å”¤é†’ã€‚</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/skynet/">skynet</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-contents--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-contents">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/skynet-%E4%B8%8E-golang-%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E6%AF%94%E8%BE%83/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynet ä¸ golang å¹¶å‘æœºåˆ¶æ¯”è¾ƒ</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E5%85%AB%E7%83%AD%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåå…«ï¼‰çƒ­æ›´æ–°æ“ä½œ</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E4%B8%83sharetable%E7%9A%84%E5%AE%9E%E7%8E%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåä¸ƒï¼‰ShareTableçš„å®ç°</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E5%85%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåå…­ï¼‰å†…å­˜ç®¡ç†</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E4%BA%94codecache%E7%9A%84%E5%AE%9E%E7%8E%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåäº”ï¼‰CodeCacheçš„å®ç°</h2>
        </div>
    </a>
</article>
            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="medetasi/homurua.github.io"
        issue-term="pathname"
        
        label="blog-comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2022 æ”¾å­¦åèŒ¶ä¼š
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.10.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ä¸»çº¿ç¨‹">ä¸»çº¿ç¨‹</a></li>
    <li><a href="#monitor-ç»“æ„">monitor ç»“æ„</a></li>
    <li><a href="#monitor-çº¿ç¨‹">monitor çº¿ç¨‹</a>
      <ol>
        <li><a href="#ä½œç”¨">ä½œç”¨</a></li>
        <li><a href="#å®ç°">å®ç°</a></li>
      </ol>
    </li>
    <li><a href="#timer-çº¿ç¨‹">timer çº¿ç¨‹</a>
      <ol>
        <li><a href="#ä½œç”¨-1">ä½œç”¨</a></li>
        <li><a href="#è‡ªå·±è®¡æ—¶çš„æ„ä¹‰">è‡ªå·±è®¡æ—¶çš„æ„ä¹‰</a></li>
        <li><a href="#æ—¶é—´æ¥å£çš„ä½¿ç”¨">æ—¶é—´æ¥å£çš„ä½¿ç”¨</a></li>
        <li><a href="#å®šæ—¶å™¨çš„å®ç°">å®šæ—¶å™¨çš„å®ç°</a></li>
      </ol>
    </li>
    <li><a href="#socket-çº¿ç¨‹">socket çº¿ç¨‹</a>
      <ol>
        <li><a href="#ä½œç”¨-2">ä½œç”¨</a></li>
      </ol>
    </li>
    <li><a href="#worker-çº¿ç¨‹">worker çº¿ç¨‹</a>
      <ol>
        <li><a href="#ä½œç”¨-3">ä½œç”¨</a></li>
        <li><a href="#æ•°é‡">æ•°é‡</a></li>
        <li><a href="#å·¥ä½œå‚æ•°">å·¥ä½œå‚æ•°</a></li>
        <li><a href="#å®ç°-1">å®ç°</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<style>
     
</style>

<script>
		
		
		
		
		
		
		
		
		
</script>


    </body>
</html>

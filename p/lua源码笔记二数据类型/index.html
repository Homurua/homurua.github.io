<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ã€€Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡æœ¬èº«ä¸å¸¦æœ‰ç±»å‹ï¼Œæœ‰å€¼äº†æ‰æœ‰ç±»å‹ã€‚å½“å‰ç‰ˆæœ¬çš„ Lua ä¸­æœ‰å…«ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ nilï¼Œbooleanï¼Œnumberï¼Œuserdataï¼Œthreadï¼Œstringï¼Œfunction å’Œ tableï¼Œæœ¬ç¯‡ä¼šåˆ†æè¿™äº›æ•°æ®ç±»å‹çš„å®ç°ã€‚
'><title>Luaæºç ç¬”è®°ï¼ˆäºŒï¼‰æ•°æ®ç±»å‹</title>

<link rel='canonical' href='https://wmf.im/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/'>

<link rel="stylesheet" href="/scss/style.min.e2f1b0a7c117e0132d2bfedd61d7ce82c7bd6daae147284607d15b4402c78602.css"><meta property='og:title' content='Luaæºç ç¬”è®°ï¼ˆäºŒï¼‰æ•°æ®ç±»å‹'>
<meta property='og:description' content='ã€€Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡æœ¬èº«ä¸å¸¦æœ‰ç±»å‹ï¼Œæœ‰å€¼äº†æ‰æœ‰ç±»å‹ã€‚å½“å‰ç‰ˆæœ¬çš„ Lua ä¸­æœ‰å…«ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ nilï¼Œbooleanï¼Œnumberï¼Œuserdataï¼Œthreadï¼Œstringï¼Œfunction å’Œ tableï¼Œæœ¬ç¯‡ä¼šåˆ†æè¿™äº›æ•°æ®ç±»å‹çš„å®ç°ã€‚
'>
<meta property='og:url' content='https://wmf.im/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/'>
<meta property='og:site_name' content='æ”¾å­¦åèŒ¶ä¼š'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='lua' /><meta property='article:published_time' content='2022-03-25T02:18:47&#43;08:00'/><meta property='article:modified_time' content='2022-03-25T02:18:47&#43;08:00'/>
<meta name="twitter:title" content="Luaæºç ç¬”è®°ï¼ˆäºŒï¼‰æ•°æ®ç±»å‹">
<meta name="twitter:description" content="ã€€Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡æœ¬èº«ä¸å¸¦æœ‰ç±»å‹ï¼Œæœ‰å€¼äº†æ‰æœ‰ç±»å‹ã€‚å½“å‰ç‰ˆæœ¬çš„ Lua ä¸­æœ‰å…«ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ nilï¼Œbooleanï¼Œnumberï¼Œuserdataï¼Œthreadï¼Œstringï¼Œfunction å’Œ tableï¼Œæœ¬ç¯‡ä¼šåˆ†æè¿™äº›æ•°æ®ç±»å‹çš„å®ç°ã€‚
">
    <link rel="shortcut icon" href="/img/dango.svg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar2_hu982b126fde96804c253e53a1f123b818_111741_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¡</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ”¾å­¦åèŒ¶ä¼š</a></h1>
            <h2 class="site-description">Please don&#39;t say &#34;You are lazy&#34;</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/medetasi'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E6%94%BE%E5%AD%A6%E5%90%8E%E8%8C%B6%E4%BC%9A/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/lua%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" style="background-color: #1398C2; color: #fff;">
                Luaç¼–ç¨‹ç¬”è®°
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">Luaæºç ç¬”è®°ï¼ˆäºŒï¼‰æ•°æ®ç±»å‹</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 25, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 17 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p>ã€€ã€€Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡æœ¬èº«ä¸å¸¦æœ‰ç±»å‹ï¼Œæœ‰å€¼äº†æ‰æœ‰ç±»å‹ã€‚å½“å‰ç‰ˆæœ¬çš„ Lua ä¸­æœ‰å…«ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ nilï¼Œbooleanï¼Œnumberï¼Œuserdataï¼Œthreadï¼Œstringï¼Œfunction å’Œ tableï¼Œæœ¬ç¯‡ä¼šåˆ†æè¿™äº›æ•°æ®ç±»å‹çš„å®ç°ã€‚</p>
<h2 id="tvalue">TValue</h2>
<p>ã€€ã€€Lua ä¸­ä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹çš„å€¼ï¼Œåœ¨ C å±‚éƒ½æ˜¯ç”¨åŒä¸€ä¸ª TValue ç»“æ„ä½“å˜é‡è¡¨ç¤ºçš„ã€‚è¿™æ ·çš„å®ç°ä¸ä¸ºä¸åŒæ•°æ®ç±»å‹å®šä¹‰ä¸åŒçš„ç»“æ„ä½“ç›¸æ¯”ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†æ¥å£ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Union of all Lua values
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">union</span> <span class="n">Value</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">GCObject</span> <span class="o">*</span><span class="n">gc</span><span class="p">;</span>    <span class="cm">/* collectable objects */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>         <span class="cm">/* light userdata */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lua_CFunction</span> <span class="n">f</span><span class="p">;</span> <span class="cm">/* light C functions */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lua_Integer</span> <span class="n">i</span><span class="p">;</span>   <span class="cm">/* integer numbers */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lua_Number</span> <span class="n">n</span><span class="p">;</span>    <span class="cm">/* float numbers */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lu_byte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Tagged Values. This is the basic representation of values in Lua:
</span></span></span><span class="line"><span class="cl"><span class="cm">** an actual value plus a tag with its type.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TValuefields    Value value_; lu_byte tt_
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">TValue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TValuefields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">TValue</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€å¯ä»¥çœ‹åˆ° TValue ä¸­çš„ç»“æ„å¾ˆç®€å•ï¼ŒåªåŒ…å«äº†ä¸€ä¸ªå®å®šä¹‰ TValuefieldsï¼Œå®ƒé‡Œé¢åˆåŒ…å«äº†ä¸€ä¸ªè¡¨ç¤ºå€¼æ•°æ®çš„ value_ å’Œä¸€ä¸ªè¡¨ç¤ºå€¼ç±»å‹çš„ tt_ ã€‚<br>
ã€€ã€€value_ æ˜¯ä¸€ä¸ª union Value è”åˆä½“å˜é‡ï¼Œå®ƒå¯ä»¥è¡¨ç¤º Lua ä¸­æ‰€æœ‰ç±»å‹å€¼çš„æ•°æ®ï¼Œä¸åŒå­—æ®µå¯¹åº”çš„ç±»å‹æ³¨é‡Šä¸­å·²ç»ç»™å‡ºï¼Œå…¶ä¸­æ‰€æœ‰éœ€è¦è¿›è¡Œ GC çš„æ•°æ®ç±»å‹çš„æŒ‡é’ˆéƒ½ä¼šä¿å­˜åœ¨ gc å­—æ®µä¸­ã€‚<br>
ã€€ã€€tt_ æ˜¯ä¸€ä¸ª unsigned char ç±»å‹ï¼Œå®ƒçš„ä¸åŒä½è¡¨ç¤ºäº†ä¸åŒçš„æ¶µä¹‰ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/tt_bits.jpg"
	width="1362"
	height="392"
	srcset="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/tt_bits_huab49f0fc1fa8b26efd229d5780b871eb_39345_480x0_resize_q75_box.jpg 480w, /p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/tt_bits_huab49f0fc1fa8b26efd229d5780b871eb_39345_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="tt_bits"
	
	
		class="gallery-image" 
		data-flex-grow="347"
		data-flex-basis="833px"
	
></p>
<p>ã€€ã€€å¯ä»¥çœ‹åˆ°å€¼çš„ç±»å‹ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯è¡¨ç¤ºåŸºç¡€ç±»å‹ï¼Œæ¯”å¦‚æ•°å­—ç±»å‹å°±æ˜¯ LUA_TNUMBERï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†è¡¨ç¤ºå˜ç§ç±»å‹ï¼ŒLua ä¸­å« variantï¼Œæ¯”å¦‚æ•°å­—ç±»å‹åˆåˆ†æˆäº†ä¸¤ç±»ï¼Œæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼Œåˆ†åˆ«ç”¨ LUA_VNUMINT å’Œ LUA_VNUMFLT è¡¨ç¤ºã€‚ä¸‹é¢æ˜¯å…¨éƒ¨çš„åŸºç¡€ç±»å‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** basic types
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TNONE           (-1)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TNIL            0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TBOOLEAN        1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TLIGHTUSERDATA  2
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TNUMBER         3
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TSTRING         4
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TTABLE          5
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TFUNCTION       6
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TUSERDATA       7
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TTHREAD         8 </span><span class="c1">// LX, LG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LUA_NUMTYPES        9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Extra types for collectable non-values
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TUPVAL    LUA_NUMTYPES  </span><span class="cm">/* upvalues */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TPROTO    (LUA_NUMTYPES+1)  </span><span class="cm">/* function prototypes */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TDEADKEY    (LUA_NUMTYPES+2)  </span><span class="cm">/* removed keys in tables */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** number of all possible types (including LUA_TNONE but excluding DEADKEY)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LUA_TOTALTYPES        (LUA_TPROTO + 2)
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gcunion--gcobject">GCUnion &amp;&amp; GCObject</h2>
<p>ã€€ã€€åœ¨äº†è§£ GCObject ä¹‹å‰é¦–å…ˆè¦çœ‹ä¸€ä¸‹ GCUnion è¿™ä¸ªè”åˆä½“ï¼Œå®ƒæ˜¯æ‰€æœ‰ GC å¯¹è±¡çœŸæ­£ä¿å­˜çš„ä½ç½®ã€‚åœ¨ GCUnion ä¸­ï¼Œæœ‰ä¸€ä¸ª GCObject gc çš„å­—æ®µï¼Œå®ƒå¹¶ä¸çœŸæ­£ä»£è¡¨æŸä¸€ç§ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªæŠ½è±¡çš„å…¬å…±å­—æ®µï¼Œæ¥æä¾›ç±»å‹è½¬æ¢ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">union</span> <span class="n">GCUnion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GCObject</span> <span class="n">gc</span><span class="p">;</span>  <span class="cm">/* common header */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">TString</span> <span class="n">ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Udata</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="n">Closure</span> <span class="n">cl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Table</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Proto</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">lua_State</span> <span class="n">th</span><span class="p">;</span>  <span class="cm">/* thread */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">UpVal</span> <span class="n">upv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€éœ€è¦ GC çš„å€¼è™½ç„¶æœ‰å„è‡ªçš„ç»“æ„ï¼Œä½†æ˜¯å¯¹å¤–çš„æ—¶å€™éƒ½æ˜¯ç»Ÿä¸€ä»¥ GCObject ä¸ºæ ‡å‡†çš„ã€‚GCObject ä¸­åŒ…å«äº†ä¸‰éƒ¨åˆ†çš„å†…å®¹ï¼Œnext æ˜¯æ•´ä¸ª GC é“¾è¡¨çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€æœ‰éœ€è¦ GC çš„å¯¹è±¡éƒ½é€šè¿‡ next è¿æ¥äº†èµ·æ¥ã€‚tt åˆæ˜¯æ•°æ®ç±»å‹ï¼Œå®ƒè·Ÿä¸Šé¢çš„ tt_ çš„ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å®ƒé‡Œé¢è¡¨ç¤ºçš„æ˜¯ GC å¯¹è±¡çš„ç±»å‹ã€‚marked ç”¨äºåœ¨ GC é˜¶æ®µçš„æ ‡è¯†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Common Header for all collectable objects (in macro form, to be
</span></span></span><span class="line"><span class="cl"><span class="cm">** included in other objects)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define CommonHeader    struct GCObject *next; lu_byte tt; lu_byte marked
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Common type for all collectable objects */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">GCObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">GCObject</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€Lua ä¸­å®šä¹‰äº†å¾ˆå¤š GCUnion åˆ° GCObject ä¹‹é—´äº’ç›¸è½¬æ¢çš„æ–¹æ³•ã€‚gco2xx ç”¨æ¥å°† GCObject è½¬ä¸ºç›®æ ‡ç±»å‹çš„ Lua å˜é‡ï¼Œobj2gco ç”¨æ¥å°† Lua å˜é‡è½¬ä¸º GCObject ç±»å‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define cast_u(o)    cast(union GCUnion *, (o))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define gco2ts(o)   check_exp(novariant((o)-&gt;tt) == LUA_TSTRING, &amp;((cast_u(o))-&gt;ts))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2u(o)    check_exp((o)-&gt;tt == LUA_VUSERDATA, &amp;((cast_u(o))-&gt;u))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2lcl(o)  check_exp((o)-&gt;tt == LUA_VLCL, &amp;((cast_u(o))-&gt;cl.l))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2ccl(o)  check_exp((o)-&gt;tt == LUA_VCCL, &amp;((cast_u(o))-&gt;cl.c))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2cl(o)   check_exp(novariant((o)-&gt;tt) == LUA_TFUNCTION, &amp;((cast_u(o))-&gt;cl))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2t(o)    check_exp((o)-&gt;tt == LUA_VTABLE, &amp;((cast_u(o))-&gt;h))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2p(o)    check_exp((o)-&gt;tt == LUA_VPROTO, &amp;((cast_u(o))-&gt;p))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2th(o)   check_exp((o)-&gt;tt == LUA_VTHREAD, &amp;((cast_u(o))-&gt;th))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define gco2upv(o)  check_exp((o)-&gt;tt == LUA_VUPVAL, &amp;((cast_u(o))-&gt;upv))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define obj2gco(v)    check_exp((v)-&gt;tt &gt;= LUA_TSTRING, &amp;(cast_u(v)-&gt;gc))
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ›å»º-gcobject">åˆ›å»º GCObject</h2>
<p>ã€€ã€€å¯ä»¥é€šè¿‡è°ƒç”¨ luaC_newobj æ¥å£åˆ›å»ºä¸€ä¸ª GCObject å˜é‡ã€‚å®ƒä¼šé¦–å…ˆä¸º GCObject åˆ†é…æ‰€éœ€å¤§å°çš„å†…å­˜ï¼Œç„¶åæŠŠ GCObject çš„ marked æ ‡è®°ä¸ºç™½è‰²ï¼Œä¿å­˜æ•°æ®ç±»å‹ ttï¼Œæœ€åå°†è‡ªå·±åŠ å…¥åˆ°å…¨å±€çš„ global_State çš„ allgc é“¾è¡¨çš„æœ€å‰é¢ã€‚</p>
<h2 id="nil">nil</h2>
<p>ã€€ã€€nil åœ¨ Lua ä¸­è¡¨ç¤ºç©ºï¼Œå› ä¸ºæ²¡æœ‰å€¼çš„ç¼˜æ•…ï¼Œå®ƒä¸éœ€è¦åœ¨ Value ä¸­æœ‰å¯¹åº”çš„å­—æ®µï¼Œåªè¦æ­£ç¡®è®¾ç½®äº†å®ƒçš„ç±»å‹ tt_ å³å¯ã€‚åŒæ—¶åœ¨åˆ¤æ–­å€¼æ˜¯å¦ä¸º nil çš„æ—¶å€™ï¼Œç›´æ¥åˆ¤æ–­ç±»å‹å³å¯ã€‚<br>
ã€€ã€€å®ƒçš„åŸºç¡€ç±»å‹éƒ½æ˜¯ LUA_TNILï¼Œæœ‰ä¸‰ä¸ªå˜ç§ç±»å‹ï¼Œåˆ†åˆ«ç”¨åœ¨ä¸‰ç§ä¸åŒæƒ…å†µä¸‹ã€‚</p>
<ul>
<li>LUA_VNIL çš„ variant å­—æ®µä¸º 0ï¼Œè¡¨ç¤ºè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªç©ºå€¼ã€‚</li>
<li>LUA_VEMPTY çš„ variant å­—æ®µä¸º 1ï¼Œè¡¨ç¤ºè¿™æ˜¯ table ä¸­çš„ä¸€ä¸ªç©º slot å€¼ã€‚</li>
<li>LUA_VABSTKEY çš„ variant å­—æ®µä¸º 2ï¼Œè¡¨ç¤ºè¿™æ˜¯ç´¢å¼• table ä¸­ä¸€ä¸ªä¸å­˜åœ¨çš„ key çš„è¿”å›å€¼ã€‚</li>
</ul>
<h2 id="boolean">boolean</h2>
<p>ã€€ã€€boolean åœ¨ Lua ä¸­æœ‰ true å’Œ false ä¸¤ä¸ªå€¼ï¼Œè¿™é‡Œä¹Ÿæ˜¯æ²¡æœ‰ä¿å­˜å€¼ï¼Œè€Œæ˜¯ç›´æ¥æŠŠä¸¤ç§å€¼ä¿å­˜ä¸ºäº†ä¸¤ä¸ªå˜ç§ç±»å‹ã€‚<br>
ã€€ã€€å®ƒçš„åŸºç¡€ç±»å‹æ˜¯ LUA_TBOOLEANï¼Œå˜ç§ç±»å‹æœ‰ä¸¤ç§ã€‚</p>
<ul>
<li>LUA_VFALSE çš„ variant å­—æ®µä¸º 0ï¼Œè¡¨ç¤º falseã€‚</li>
<li>LUA_VTRUE çš„ variant å­—æ®µä¸º 1ï¼Œè¡¨ç¤º trueã€‚</li>
</ul>
<h2 id="number">number</h2>
<p>ã€€ã€€æ•°å­—çš„åŸºç¡€ç±»å‹ä¸º LUA_TNUMBERï¼Œæœ‰ä¸¤ä¸ªå˜ç§ç±»å‹ï¼Œåˆ†åˆ«ä»£è¡¨äº†æ•´æ•°å’Œæµ®ç‚¹æ•°ã€‚</p>
<ul>
<li>LUA_VNUMINT çš„ variant å­—æ®µä¸º 0ï¼Œè¡¨ç¤ºæ•´æ•°ã€‚</li>
<li>LUA_VNUMFLT çš„ variant å­—æ®µä¸º 1ï¼Œè¡¨ç¤ºæµ®ç‚¹æ•°ã€‚</li>
</ul>
<p>ã€€ã€€æ•°æ®ä¿å­˜åœ¨ union Value ä¸­ï¼Œæ•´æ•°ä½¿ç”¨çš„æ˜¯ long long ç±»å‹çš„ i å­—æ®µï¼Œæµ®ç‚¹æ•°ä½¿ç”¨çš„æ˜¯ double ç±»å‹çš„ n å­—æ®µã€‚</p>
<h2 id="userdata">userdata</h2>
<p>ã€€ã€€Lua ä¸­çš„ userdata åˆ†ä¸ºä¸¤ç±»ï¼Œlightuserdata å’Œ userdataï¼Œå…¶ä¸­ lightuserdata æ˜¯æŒ‡å†…å­˜ä¸éœ€è¦ Lua ç®¡ç†çš„æŒ‡é’ˆï¼Œuserdata æ˜¯éœ€è¦ Lua è´Ÿè´£ç®¡ç†å†…å­˜çš„æ•°æ®æŒ‡é’ˆã€‚<br>
ã€€ã€€åœ¨åŸºç¡€ç±»å‹å®šä¹‰ä¸­ï¼Œlightuserdata è¢«å®šä¹‰ä¸ºäº† LUA_TLIGHTUSERDATAï¼Œuserdata è¢«å®šä¹‰ä¸ºäº† LUA_TUSERDATAï¼Œè™½ç„¶åˆ†äº†ä¸¤ä¸ªåŸºç¡€ç±»å‹ï¼Œä½†æ˜¯åœ¨ Lua5.4 ä¸­çš„æ³¨é‡Šé‡Œæåˆ°äº†ï¼Œåº”è¯¥æŠŠ lightuserdata çœ‹ä½œæ˜¯ userdata çš„ä¸€ä¸ªå˜ç§ç±»å‹ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ€§æ‰ä¿ç•™äº†ä¸¤ä¸ªåŸºç¡€ç±»å‹ã€‚<br>
ã€€ã€€lightuserdata å› ä¸ºä¸éœ€è¦ä¿å­˜æ•°æ®ï¼Œæ‰€ä»¥åªä¿å­˜ä¸€ä¸ªæŒ‡é’ˆå˜é‡å³å¯ï¼Œä¸Šæ–‡æåˆ°çš„ union Value ä¸­çš„ p å­—æ®µå°±æ˜¯ç”¨æ¥ä¿å­˜ lightuserdata çš„æŒ‡é’ˆçš„ã€‚<br>
ã€€ã€€userdata éœ€è¦ç®¡ç†æ•°æ®ï¼Œç›¸æ¯” lightuserdata å®ƒéœ€è¦é¢å¤–åˆ›å»ºä¸€ä¸ª Udata å˜é‡ç”¨æ¥ä¿å­˜è‡ªå·±çš„æ•°æ®ï¼ŒåŒæ—¶å®ƒå±äºéœ€è¦ GC çš„ç±»å‹ï¼Œä¼šé€šè¿‡ luaC_newobj è¿›è¡Œåˆ›å»ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Header for userdata with user values;
</span></span></span><span class="line"><span class="cl"><span class="cm">** memory area follows the end of this structure.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Udata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nuvalue</span><span class="p">;</span>  <span class="cm">/* number of user values */</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>  <span class="cm">/* number of bytes */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Table</span> <span class="o">*</span><span class="n">metatable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GCObject</span> <span class="o">*</span><span class="n">gclist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UValue</span> <span class="n">uv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* user values */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Udata</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="thread">thread</h2>
<p>ã€€ã€€thread åœ¨ Lua ä¸­ç”¨æ¥æŒ‡ä»£åç¨‹ï¼Œæ‰€æœ‰åç¨‹çš„ç±»å‹éƒ½æ˜¯ LUA_TTHREADï¼Œåªæœ‰è¿™ä¸€ä¸ªåŸºç¡€ç±»å‹ã€‚å˜ç§ç±»å‹ä¹Ÿåªæœ‰ä¸€ä¸ª LUA_VTHREADï¼Œå®ƒçš„ variant å€¼ä¸º 0ã€‚<br>
ã€€ã€€åç¨‹åœ¨ Lua ä¸­æ˜¯ lua_State ç»“æ„ä½“çš„å˜é‡ï¼Œç”±äºå®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„æ•°æ®ç±»å‹ï¼Œè¿˜è·Ÿ Lua çš„è™šæ‹Ÿæœºæœ‰å¾ˆå¤§å…³ç³»ï¼Œæ‰€ä»¥ä¸åœ¨è¿™é‡Œåšå±•å¼€äº†ï¼Œåé¢ä¼šä¸“é—¨å¼€ä¸€ç¯‡å†™è¿™ä¸ªã€‚</p>
<h2 id="string">string</h2>
<p>ã€€ã€€å­—ç¬¦ä¸²çš„åŸºç¡€ç±»å‹ä¸º LUA_TSTRINGï¼Œæœ‰ä¸¤ä¸ªå˜ç§ç±»å‹ï¼Œåˆ†åˆ«ä»£è¡¨äº†çŸ­å­—ç¬¦ä¸²å’Œé•¿å­—ç¬¦ä¸²ï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦å°äºç­‰äº 40 ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œå±äºçŸ­å­—ç¬¦ä¸²ï¼Œåä¹‹åˆ™å±äºé•¿å­—ç¬¦ä¸²ã€‚</p>
<ul>
<li>LUA_VSHRSTR çš„ variant å­—æ®µä¸º 0ï¼Œè¡¨ç¤ºçŸ­å­—ç¬¦ä¸²ã€‚</li>
<li>LUA_VLNGSTR çš„ variant å­—æ®µä¸º 1ï¼Œè¡¨ç¤ºé•¿å­—ç¬¦ä¸²ã€‚</li>
</ul>
<h3 id="ç»“æ„">ç»“æ„</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Header for a string value.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">TString</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span> <span class="c1">// struct GCObject *next; lu_byte tt; lu_byte marked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lu_byte</span> <span class="n">extra</span><span class="p">;</span>  <span class="cm">/* reserved words for short strings; &#34;has hash&#34; for longs */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">shrlen</span><span class="p">;</span>  <span class="cm">/* length for short strings */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span> <span class="c1">// å“ˆå¸Œå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">size_t</span> <span class="n">lnglen</span><span class="p">;</span>  <span class="cm">/* length for long strings */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">TString</span> <span class="o">*</span><span class="n">hnext</span><span class="p">;</span>  <span class="cm">/* linked list for hash table */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// ä¿å­˜å­—ç¬¦ä¸²çš„å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">TString</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€çŸ­å­—ç¬¦ä¸²ä¸é•¿å­—ç¬¦ä¸²ä½¿ç”¨åŒä¸€ç§ç»“æ„ä½“è¡¨ç¤ºã€‚é™¤äº†æ‰€æœ‰ GCObject éƒ½æœ‰çš„ CommonHeader ä»¥å¤–ï¼Œextra åœ¨çŸ­å­—ç¬¦ä¸²ä¸­è¡¨ç¤ºæ˜¯å¦æ˜¯ä¿ç•™å­—ï¼Œåœ¨é•¿å­—ç¬¦ä¸²ä¸­è¡¨ç¤ºæ˜¯å¦å·²ç»è®¡ç®—è¿‡äº†å“ˆå¸Œå€¼ã€‚shrlen è¡¨ç¤ºçŸ­å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œhash è¡¨ç¤ºæœ¬å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ï¼Œunion u ä¸­çš„ lnglen è¡¨ç¤ºé•¿å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œhnext ç”¨æ¥å½“ä½œçŸ­å­—ç¬¦ä¸²å“ˆå¸Œæ¡¶çš„é“¾è¡¨æŒ‡é’ˆï¼Œcontents ä¿å­˜äº†å­—ç¬¦ä¸²çš„å†…å®¹ã€‚</p>
<h3 id="å…¨å±€å­—ç¬¦ä¸²è¡¨">å…¨å±€å­—ç¬¦ä¸²è¡¨</h3>
<p>ã€€ã€€Lua å°†çŸ­å­—ç¬¦ä¸²è¿›è¡Œäº†å†…åŒ–å¤„ç†ï¼Œç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²åªä¼šä¿å­˜ä¸€ä»½ã€‚åœ¨å…¨å±€çš„ global_State ä¸­æœ‰ä¸€ä¸ªå“ˆå¸Œæ¡¶ç”¨æ¥ä¿å­˜å…¨éƒ¨çš„çŸ­å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">stringtable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TString</span> <span class="o">**</span><span class="n">hash</span><span class="p">;</span> <span class="c1">// å“ˆå¸Œæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">nuse</span><span class="p">;</span>  <span class="cm">/* number of elements */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">stringtable</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€å®ƒçš„ nuse è¡¨ç¤ºçš„æ˜¯å½“å‰å“ˆå¸Œæ¡¶ä¸­æ€»å…±çš„å…ƒç´ ä¸ªæ•°ï¼Œsize è¡¨ç¤ºçš„æ˜¯å“ˆå¸Œæ¡¶çš„é•¿åº¦ã€‚<br>
ã€€ã€€å…¨å±€å­—ç¬¦ä¸²è¡¨ä¼šåœ¨ luaS_init ä¸­è¢«åˆå§‹åŒ–ï¼Œå®ƒçš„åˆå§‹é•¿åº¦æ˜¯ 128ï¼Œç»™å“ˆå¸Œæ¡¶åˆ†é…å†…å­˜ä»¥åï¼Œä¼šè°ƒç”¨ tablerehash å¡«å……å“ˆå¸Œæ¡¶ã€‚<br>
ã€€ã€€tablerehash æ˜¯ç”¨æ¥æ‰§è¡Œå“ˆå¸Œæ¡¶çš„ rehash çš„ï¼Œåœ¨éœ€è¦ä¿®æ”¹å“ˆå¸Œæ¡¶çš„é•¿åº¦çš„æ—¶å€™å°±ä¼šæ‰§è¡Œï¼Œå®ƒä¼šéå†ä¹‹å‰æ‰€æœ‰å­—ç¬¦ä¸²ï¼ŒæŠŠå®ƒä»¬æŒ‰æ–°çš„é•¿åº¦é‡æ–°è®¡ç®—åœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®ã€‚</p>
<h3 id="åˆ›å»ºå­—ç¬¦ä¸²">åˆ›å»ºå­—ç¬¦ä¸²</h3>
<p>ã€€ã€€luaS_newlstr æ˜¯åˆ›å»ºå­—ç¬¦ä¸²å˜é‡çš„æ¥å£ï¼Œä¸ç®¡é•¿å­—ç¬¦ä¸²è¿˜æ˜¯çŸ­å­—ç¬¦ä¸²éƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°åˆ›å»ºã€‚å®ƒåœ¨å®ç°çš„æ—¶å€™é€šè¿‡å­—ç¬¦ä¸²é•¿åº¦åˆ¤æ–­ï¼Œå¦‚æœé•¿åº¦å°äºç­‰äº 40 åˆ™è°ƒç”¨ internshrstr åˆ›å»ºä¸€ä¸ªçŸ­å­—ç¬¦ä¸²ï¼Œåä¹‹åˆ™è°ƒç”¨ luaS_createlngstrobj åˆ›å»ºä¸€ä¸ªé•¿å­—ç¬¦ä¸²ã€‚<br>
ã€€ã€€ä¸ç®¡æ˜¯ internshrstr è¿˜æ˜¯ luaS_createlngstrobjï¼Œåœ¨å¤„ç†å®Œè‡ªå·±ç‰¹åŒ–çš„å·¥ä½œä»¥åï¼Œæœ€åéƒ½ä¼šè°ƒç”¨åˆ° createstrobj æ¥åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ï¼Œå®ƒä¼šé¦–å…ˆè®¡ç®—å‡ºæœ¬å˜é‡æ‰€éœ€çš„å…¨éƒ¨å†…å­˜å¤§å°ï¼Œç„¶åè°ƒç”¨ä¸Šæ–‡æåˆ°çš„ luaC_newobj åˆ›å»ºä¸€ä¸ª GCObject å‡ºæ¥ï¼Œé€šè¿‡ gco2ts æŠŠå®ƒè½¬ä¸º TString ç»“æ„ï¼Œä½¿ç”¨ hash å­—æ®µä¿å­˜å®ƒçš„å“ˆå¸Œå€¼ï¼ŒæŠŠ extra å­—æ®µè®¾ä¸º 0ï¼Œå¹¶ä¸”ä¼šåœ¨ contents æœ€åè¡¥ä¸Šä¸€ä¸ª &lsquo;\0&rsquo; è¡¨ç¤ºç»“æŸã€‚</p>
<h3 id="çŸ­å­—ç¬¦ä¸²">çŸ­å­—ç¬¦ä¸²</h3>
<p>ã€€ã€€çŸ­å­—ç¬¦ä¸²åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¿®æ”¹å…¨å±€å­—ç¬¦ä¸²è¡¨ï¼Œé¦–å…ˆæ‹¿åˆ° global_State çš„å“ˆå¸Œæ¡¶å˜é‡ strtï¼Œç„¶åé€šè¿‡ luaS_hash è®¡ç®—å½“å‰å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ã€‚è¿™é‡Œä¼šå‘ç° global_State ä¸­æœ‰ä¸€ä¸ªéšæœºç§å­å˜é‡ seedï¼Œå®ƒä¼šå‚ä¸åˆ°æœ¬è¿›ç¨‹ä¸­å­—ç¬¦ä¸²å“ˆå¸Œå€¼çš„è®¡ç®—é‡Œã€‚<br>
ã€€ã€€é€šè¿‡å°†å­—ç¬¦ä¸²çš„å“ˆå¸Œç»“æœå¯¹å“ˆå¸Œæ¡¶çš„ size å–æ¨¡å¾—åˆ°ç›®æ ‡æ¡¶çš„ä½ç½®ï¼Œä¾æ¬¡éå†æ¡¶ä¸­çš„æ•°æ®ï¼Œé€šè¿‡æ¯”è¾ƒé•¿åº¦å’Œæ•°æ®ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰è·Ÿç›®æ ‡å­—ç¬¦ä¸²ä¸€æ ·çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›å®ƒçš„æŒ‡é’ˆå³å¯ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°å­—ç¬¦ä¸²ï¼Œåˆ™é€šè¿‡ createstrobj åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ï¼Œç„¶åä½¿ç”¨ memcpy æŠŠå¾…åˆ›å»ºå­—ç¬¦ä¸²å¤åˆ¶è¿›æ¥ã€‚çŸ­å­—ç¬¦ä¸²ä½¿ç”¨ shrlen ä¿å­˜å­—ç¬¦ä¸²é•¿åº¦ï¼Œä½¿ç”¨ union u çš„ hnext ä¿å­˜å“ˆå¸Œæ¡¶ä¸­é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå€¼ã€‚<br>
ã€€ã€€å½“éœ€è¦åˆ é™¤ä¸€ä¸ªçŸ­å­—ç¬¦ä¸²æ—¶ï¼Œé™¤äº†éœ€è¦å¤„ç†å†…å­˜å›æ”¶ï¼Œè¿˜è¦æŠŠå…¨å±€å“ˆå¸Œæ¡¶ä¸­çš„å€¼ä¹Ÿç§»é™¤æ‰ã€‚ç§»é™¤çš„æ—¶å€™é€šè¿‡å­—ç¬¦ä¸²çš„ hash å€¼è®¡ç®—å‡ºå¯¹åº”çš„é“¾è¡¨ï¼Œç„¶åéœ€è¦éå†é“¾è¡¨æŸ¥æ‰¾å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°ä»¥åä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶ä¸”å°†å“ˆå¸Œæ¡¶çš„ nuse å‡ä¸€ã€‚</p>
<h3 id="é•¿å­—ç¬¦ä¸²">é•¿å­—ç¬¦ä¸²</h3>
<p>ã€€ã€€é•¿å­—ç¬¦ä¸²åœ¨ Lua ä¸­å½“ä½œæ™®é€šçš„ GCObject å¤„ç†ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œä¼šæŠŠå­—ç¬¦ä¸²çš„é•¿åº¦ä¿å­˜åœ¨ union u çš„ lnglen ä¸­ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡º Lua å¯¹å†…å­˜ä½¿ç”¨çš„ä¼˜åŒ–æ˜¯å¾ˆåˆ°ä½çš„ï¼Œå¦‚æœä¸æ˜¯ä¸ºäº†å†…å­˜ä¼˜åŒ–ï¼Œå®Œå…¨å¯ä»¥æŠŠé•¿å­—ç¬¦ä¸²çš„é•¿åº¦ä¹Ÿä¿å­˜åœ¨ shrlen ä¸­ï¼Œè¿™é‡Œè·ŸçŸ­å­—ç¬¦ä¸²çš„ hnext å…±ç”¨ä¸€ä¸ª unionï¼Œæ˜¯ä¸ºäº†å¯ä»¥æŠŠçŸ­å­—ç¬¦ä¸²çš„é•¿åº¦ç±»å‹å˜ä¸º unsigned char ç±»å‹ã€‚<br>
ã€€ã€€é•¿å­—ç¬¦ä¸²åœ¨è°ƒç”¨ createstrobj åˆ›å»º TString æ—¶ï¼Œä¸ä¼šè®¡ç®—å“ˆå¸Œå€¼ï¼Œè€Œæ˜¯æŠŠ global_State çš„ seed ä¿å­˜åœ¨äº† TString çš„ hash å­—æ®µä¸­ã€‚åœ¨ TString åˆ›å»ºå®Œæˆä»¥åï¼Œä¸€æ ·ä½¿ç”¨ memcpy æŠŠå¾…åˆ›å»ºå­—ç¬¦ä¸²çš„å†…å®¹å¤åˆ¶è¿›æ¥ã€‚<br>
ã€€ã€€é•¿å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼åªæœ‰åœ¨éœ€è¦ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šé€šè¿‡ luaS_hashlongstr è®¡ç®—ï¼Œæ¯”å¦‚è¯´æŸ¥æ‰¾ table çš„ key çš„æ—¶å€™å°±ä¼šéœ€è¦å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ï¼Œè®¡ç®—æ–¹æ³•ä¸çŸ­å­—ç¬¦ä¸²ä¸€æ ·ã€‚åœ¨è®¡ç®—å“ˆå¸Œä¹‹å‰é•¿å­—ç¬¦ä¸²çš„ extra ä¸º 0ï¼Œè¡¨ç¤ºæ²¡æœ‰è®¡ç®—è¿‡å“ˆå¸Œå€¼ï¼Œå¹¶ä¸”æ­¤æ—¶ TString çš„ hash ä¸­ä¿å­˜çš„æ˜¯ global_State çš„ seedï¼Œè®¡ç®—å®Œä»¥åï¼Œä¼šå°† hash æ”¹ä¸ºä¿å­˜çœŸæ­£çš„å“ˆå¸Œå€¼ï¼Œå¹¶ä¸”å°† extra æ”¹ä¸º 1 è¡¨ç¤ºå·²ç»è®¡ç®—è¿‡å“ˆå¸Œå€¼ï¼Œä¸‹æ¬¡éœ€è¦è®¡ç®—çš„æ—¶å€™ï¼Œå¦‚æœ extra ç­‰äº 1ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å› hash ä¸­çš„å€¼äº†ã€‚</p>
<h3 id="æ¯”è¾ƒå­—ç¬¦ä¸²">æ¯”è¾ƒå­—ç¬¦ä¸²</h3>
<p>ã€€ã€€åœ¨ lvm.c çš„ luaV_equalobj ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“åŒæ–¹éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œæ¯”è¾ƒä½¿ç”¨çš„æ–¹æ³•æ˜¯ eqshrstrï¼Œå½“éƒ½æ˜¯é•¿å­—ç¬¦ä¸²æ—¶ï¼Œæ¯”è¾ƒä½¿ç”¨çš„æ˜¯ luaS_eqlngstr å‡½æ•°ã€‚<br>
ã€€ã€€å› ä¸ºçŸ­å­—ç¬¦ä¸²æ˜¯å†…åŒ–çš„ï¼Œæ‰€ä»¥ eqshrstr çš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥æ¯”è¾ƒä¸¤ä¸ªå‚æ•°çš„å†…å­˜åœ°å€å³å¯ï¼Œç›¸åŒçŸ­å­—ç¬¦ä¸²éƒ½æ˜¯å¼•ç”¨çš„åŒä¸€ä¸ª TString å˜é‡ï¼Œåœ°å€ç›¸åŒå³ç›¸ç­‰ï¼Œåä¹‹åˆ™ä¸ç­‰ã€‚<br>
ã€€ã€€ç”±äºé•¿å­—ç¬¦ä¸²å¹¶æ²¡æœ‰è¿›è¡Œå†…åŒ–ï¼Œæ‰€ä»¥ luaS_eqlngstr å°±éº»çƒ¦ä¸€äº›ï¼Œä¼šå…ˆæ¯”è¾ƒå†…å­˜åœ°å€ï¼Œå¦‚æœä¸ç­‰çš„è¯ï¼Œåˆ™æ¯”è¾ƒé•¿åº¦ï¼Œé•¿åº¦ç›¸ç­‰å†ä½¿ç”¨ memecmp æ¯”è¾ƒå†…å®¹ã€‚</p>
<h3 id="ä¿ç•™å­—ç¬¦ä¸²">ä¿ç•™å­—ç¬¦ä¸²</h3>
<p>ã€€ã€€Lua ä¸­æœ‰ä¸€äº›ä¿ç•™å­—ç¬¦ä¸²ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯å…³é”®å­—ã€‚ä¿ç•™å­—ç¬¦ä¸²éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²ï¼ŒTString ä¸­çš„ extra å­—æ®µå°±æ˜¯ç”¨æ¥æ ‡è¯†ä¿ç•™å­—ç¬¦ä¸²çš„ã€‚<br>
ã€€ã€€ä¿ç•™å­—ç¬¦ä¸²ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«å…¨éƒ¨åˆ›å»ºï¼Œextra ä¼šè¢«é¡ºåºé€’å¢ã€‚åŒæ—¶æ‰€æœ‰ä¿ç•™å­—ç¬¦ä¸²éƒ½ä¼šé€šè¿‡ luaC_fix å°†å…¶å›ºå®šä¸‹æ¥ï¼Œæ°¸è¿œä¸ä¼šè¢«å›æ”¶ã€‚</p>
<h2 id="proto">proto</h2>
<p>ã€€ã€€proto æ˜¯ prototype çš„ç®€å†™ï¼Œè¡¨ç¤ºå‡½æ•°åŸå‹ã€‚å®ƒçš„åŸºç¡€ç±»å‹æ˜¯ LUA_TPROTOï¼Œåªæœ‰ä¸€ä¸ªå˜ç§ç±»å‹æ˜¯ LUA_VPROTOï¼Œå®ƒæœ¬èº«å¹¶ä¸æ˜¯ Lua å¯¹å¤–æä¾›çš„ä¸€ç±»å€¼ï¼Œä½†æ˜¯å®ƒæ˜¯å•ç‹¬çš„ä¸€ç±» GCObjectï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ function å˜é‡çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œæ‰€ä»¥åœ¨ function ä¹‹å‰å…ˆè®²ä¸€ä¸‹ proto çš„ç»“æ„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Upvaldesc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>  <span class="cm">/* upvalue name (for debug information) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">instack</span><span class="p">;</span>  <span class="cm">/* whether it is in stack (register) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">idx</span><span class="p">;</span>  <span class="cm">/* index of upvalue (in stack or in outer function&#39;s list) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">kind</span><span class="p">;</span>  <span class="cm">/* kind of corresponding variable */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Upvaldesc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">LocVar</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TString</span> <span class="o">*</span><span class="n">varname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">startpc</span><span class="p">;</span>  <span class="cm">/* first point where variable is active */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">endpc</span><span class="p">;</span>    <span class="cm">/* first point where variable is dead */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">LocVar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">AbsLineInfo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">AbsLineInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Proto</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">numparams</span><span class="p">;</span>  <span class="cm">/* number of fixed (named) parameters */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">is_vararg</span><span class="p">;</span> <span class="c1">// æ˜¯å¦ç”¨äº†å¯å˜å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lu_byte</span> <span class="n">maxstacksize</span><span class="p">;</span>  <span class="cm">/* number of registers needed by this function */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sizeupvalues</span><span class="p">;</span>  <span class="cm">/* size of &#39;upvalues&#39; */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sizek</span><span class="p">;</span>  <span class="cm">/* size of &#39;k&#39; */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sizecode</span><span class="p">;</span> <span class="c1">// code çš„é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sizelineinfo</span><span class="p">;</span> <span class="c1">// lineinfo çš„é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sizep</span><span class="p">;</span>  <span class="cm">/* size of &#39;p&#39; */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sizelocvars</span><span class="p">;</span> <span class="c1">// locvars çš„é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sizeabslineinfo</span><span class="p">;</span>  <span class="cm">/* size of &#39;abslineinfo&#39; */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">linedefined</span><span class="p">;</span>  <span class="cm">/* debug information  */</span> <span class="c1">// å‡½æ•°å®šä¹‰çš„èµ·å§‹ä½ç½®è¡Œæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">lastlinedefined</span><span class="p">;</span>  <span class="cm">/* debug information  */</span> <span class="c1">// å‡½æ•°å®šä¹‰çš„æœ«å°¾ä½ç½®è¡Œæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TValue</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>  <span class="cm">/* constants used by the function */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Instruction</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>  <span class="cm">/* opcodes */</span> <span class="c1">// å­—èŠ‚ç ä¿å­˜çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">Proto</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>  <span class="cm">/* functions defined inside the function */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Upvaldesc</span> <span class="o">*</span><span class="n">upvalues</span><span class="p">;</span>  <span class="cm">/* upvalue information */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ls_byte</span> <span class="o">*</span><span class="n">lineinfo</span><span class="p">;</span>  <span class="cm">/* information about source lines (debug information) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbsLineInfo</span> <span class="o">*</span><span class="n">abslineinfo</span><span class="p">;</span>  <span class="cm">/* idem */</span>
</span></span><span class="line"><span class="cl">    <span class="n">LocVar</span> <span class="o">*</span><span class="n">locvars</span><span class="p">;</span>  <span class="cm">/* information about local variables (debug information) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TString</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>  <span class="cm">/* used for debug information */</span>
</span></span><span class="line"><span class="cl">    <span class="n">GCObject</span> <span class="o">*</span><span class="n">gclist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Proto</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€å¯ä»¥çœ‹åˆ° proto çš„ç»“æ„ä¸­æ•°æ®è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œé™¤äº†æ‰€æœ‰ GCObject éƒ½æœ‰çš„ CommonHeader ä»¥å¤–ï¼Œå…¶ä½™çš„æ•°æ®å¤§æ¦‚å¯ä»¥åˆ†ä¸ºå‡ ç§ç±»å‹ã€‚</p>
<ul>
<li>å‚æ•°ç›¸å…³<br>
å‡½æ•°çš„å‚æ•°å¯ä»¥åŒ…æ‹¬è‹¥å¹²ä¸ªå›ºå®šå‚æ•°å’Œä¸€ç»„ä¸å®šå‚æ•°ï¼Œå› ä¸º Lua è§„å®šäº†å›ºå®šå‚æ•°å¿…é¡»æ”¾åœ¨ä¸å®šå‚æ•°ä¹‹å‰ï¼Œä¸å­˜åœ¨äº¤å‰çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥åªéœ€è¦ä½¿ç”¨ numparams è®°å½•å›ºå®šå‚æ•°çš„ä¸ªæ•°ï¼Œä½¿ç”¨ is_vararg æ¥è®°å½•å‡½æ•°æ˜¯å¦æ¥å—ä¸å®šå‚æ•°å³å¯ã€‚</li>
<li>è°ƒè¯•ä¿¡æ¯<br>
debug æ¥å£éœ€è¦è·å¾—ä¸€äº›å…³äºå‡½æ•°çš„è°ƒè¯•ä¿¡æ¯ï¼Œæ¯”å¦‚å®šä¹‰çš„ä½ç½®ç­‰ï¼Œè¿™äº›ä¹Ÿéƒ½åœ¨ proto ç»“æ„é‡Œã€‚linedefined è®°å½•äº†å‡½æ•°å®šä¹‰å¼€å§‹çš„è¡Œæ•°ï¼Œlastlinedefined è®°å½•äº†å‡½æ•°å®šä¹‰ç»“æŸçš„è¡Œæ•°ï¼Œsource è®°å½•äº†æºæ–‡ä»¶çš„åœ°å€ã€‚ä¸ä»…è¿™ä¸‰ä¸ªï¼Œåªè¦éœ€è¦ï¼Œå…¶å®ƒå˜é‡ä¹Ÿå¯ä»¥é€šè¿‡ debug æ¥å£æ¥è¯»å–ã€‚</li>
<li>upvalue<br>
å‡½æ•°ä½¿ç”¨çš„ upvalue åœ¨ä¸€ä¸ªæ•°ç»„ upvalues ä¸­ï¼ŒåŒæ—¶ä½¿ç”¨ sizeupvalues å˜é‡è®°å½•æ•°ç»„çš„é•¿åº¦ã€‚upvalue æœ‰ä¸€ä¸ªè‡ªå·±çš„ç»“æ„ä½“ Upvaldescï¼Œæ¯ä¸ª Upvaldesc ç”±åå­— nameï¼Œæ˜¯å¦åœ¨æ ˆä¸­çš„çŠ¶æ€ instackï¼Œç´¢å¼• idx å’Œç±»å‹ kind ç»„æˆã€‚</li>
<li>å¸¸é‡<br>
å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„å¸¸é‡ä¼šä¿å­˜åœ¨ k ä¸­ï¼Œæ¯ä¸ªå¸¸é‡ä½¿ç”¨ Lua å€¼çš„ TValue æ¥è¡¨ç¤ºã€‚k æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„é•¿åº¦ä¿å­˜åœ¨ sizek ä¸­ã€‚</li>
<li>æŒ‡ä»¤ç <br>
code ä¸­ä¿å­˜çš„æ˜¯å‡½æ•°çš„æŒ‡ä»¤ç ï¼Œæ˜¯ä¸€ä¸ª Instruction ç±»å‹çš„æ•°ç»„ï¼ŒInstruction æœ¬èº«æ˜¯ Lua ä¸­æŒ‡ä»¤ç çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ª unsigned int ç±»å‹ã€‚sizecode æ˜¯ code çš„é•¿åº¦ã€‚</li>
<li>è°ƒç”¨ä½ç½®<br>
åœ¨ lineinfo ä¸­è®°å½•äº†è°ƒç”¨æœ¬å‡½æ•°çš„è¡Œæ•°ï¼Œsizelineinfo è®°å½•äº† lineinfo çš„é•¿åº¦ã€‚</li>
<li>å­å‡½æ•°<br>
å‡½æ•°ä¸­çš„å­å‡½æ•°çš„åŸå‹è®°å½•åœ¨ p ä¸­ï¼Œæ˜¯ä¸€ä¸ª Proto æŒ‡é’ˆçš„æ•°ç»„ï¼Œå®ƒçš„é•¿åº¦åœ¨ sizep é‡Œè®°å½•ã€‚</li>
<li>local å˜é‡<br>
å‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡å­˜æ”¾åœ¨ locvars ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ª LocVar ç»“æ„çš„æ•°ç»„ï¼Œsizelocvars ä¿å­˜äº†å®ƒçš„é•¿åº¦ã€‚æ¯ä¸ª LocVar å˜é‡åˆè‡ªå·±çš„å˜é‡åï¼Œå¼€å§‹ç”Ÿæ•ˆçš„ç‚¹å’Œå¤±æ•ˆçš„ç‚¹ã€‚</li>
<li>ç»å¯¹è¡Œæ•°<br>
abslineinfo ä¿å­˜äº†ç»å¯¹è¡Œæ•°çš„ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ª AbsLineInfo ç»“æ„çš„æ•°ç»„ï¼Œsizeabslineinfo ä¿å­˜äº†å®ƒçš„é•¿åº¦ã€‚æ¯ä¸ª AbsLineInfo ä¸­ä¿å­˜äº†ä¸€ä¸ª pc å’Œä¸€ä¸ªè¡Œæ•°ã€‚</li>
</ul>
<h2 id="function">function</h2>
<p>ã€€ã€€å‡½æ•°çš„åŸºç¡€ç±»å‹æ˜¯ LUA_TFUNCTIONï¼Œæœ‰ä¸‰ä¸ªå˜ç§ç±»å‹ã€‚</p>
<ul>
<li>LUA_VLCL è¡¨ç¤º Lua é—­åŒ…ï¼Œvariant å€¼ä¸º 0</li>
<li>LUA_VLCF è¡¨ç¤ºè½»é‡ C å‡½æ•°ï¼Œvariant å€¼ä¸º 1</li>
<li>LUA_VCCL è¡¨ç¤º C é—­åŒ…ï¼Œvariant å€¼ä¸º 2</li>
</ul>
<p>ã€€ã€€ä¸‰ç§ç±»å‹çš„å˜é‡éƒ½æ˜¯ä½¿ç”¨åŒä¸€ä¸ªè”åˆä½“ union Closure æ¥è¡¨ç¤ºçš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">union</span> <span class="n">Closure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CClosure</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LClosure</span> <span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Closure</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="lua-é—­åŒ…">Lua é—­åŒ…</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define ClosureHeader CommonHeader; lu_byte nupvalues; GCObject *gclist
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">UpVal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">tbc</span><span class="p">;</span>  <span class="cm">/* true if it represents a to-be-closed variable */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TValue</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>  <span class="cm">/* points to stack or to its own value */</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>  <span class="cm">/* (when open) */</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">UpVal</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>  <span class="cm">/* linked list */</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">UpVal</span> <span class="o">**</span><span class="n">previous</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">open</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">TValue</span> <span class="n">value</span><span class="p">;</span>  <span class="cm">/* the value (when closed) */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UpVal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">LClosure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ClosureHeader</span><span class="p">;</span> <span class="c1">// gc ç›¸å…³å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">Proto</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="c1">// å‡½æ•°åŸå‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UpVal</span> <span class="o">*</span><span class="n">upvals</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* list of upvalues */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">LClosure</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€æ¯ä¸ª Lua é—­åŒ…æ˜¯ä¸€ä¸ª LClosure å˜é‡ï¼Œå®ƒä¸»è¦åŒ…æ‹¬äº†ä¸€ä¸ªå‡½æ•°åŸå‹å’Œä¸€ä¸ª upvalue çš„æ•°ç»„ã€‚è¿™ä¸ª upvalue æ˜¯å‡½æ•°æ‰€åœ¨ä½ç½®çš„ upvalueï¼Œè¦æ³¨æ„è·Ÿå‡½æ•°åŸå‹æ‰€åœ¨ä½ç½®çš„ upvalue åŒºåˆ†ã€‚<br>
ã€€ã€€UpVal ä¸­å€¼ä¿å­˜çš„æƒ…å†µæœ‰ä¸¤ç§ï¼Œopen å’Œ closedï¼Œopen ä»£è¡¨çš„æ˜¯åŸå€¼æ²¡æœ‰è¢«é‡Šæ”¾çš„æƒ…å†µï¼Œæ¯”å¦‚å½“å­å‡½æ•°åœ¨çˆ¶å‡½æ•°ä¸­è¿è¡Œæ—¶ï¼Œçˆ¶å‡½æ•°é‡Œ upvalue å°±æ˜¯ open çŠ¶æ€ï¼Œåœ¨ open çŠ¶æ€ä¸‹çš„ upvalue å¹¶ä¸ä¼šä¿å­˜å®ƒçš„å€¼ï¼Œè€Œæ˜¯åªä½¿ç”¨ TValue *v ä¿å­˜äº†ä¸€ä¸ªæŒ‡é’ˆã€‚<br>
ã€€ã€€closed ä»£è¡¨åŸå€¼å·²ç»è¢«é‡Šæ”¾çš„æƒ…å†µï¼Œæ¯”å¦‚å­å‡½æ•°è¢«å½“ä½œè¿”å›å€¼è¿”å›ï¼Œç„¶ååœ¨å¤–éƒ¨æ‹¿åˆ°è¿”å›å€¼ä»¥åæ‰§è¡Œçš„æƒ…å†µï¼Œè¿™æ—¶å€™çˆ¶å‡½æ•°ä¸­çš„ upvalue å·²ç»é‡Šæ”¾äº†ï¼Œä¸èƒ½å†ä¿å­˜æŒ‡é’ˆäº†ï¼Œè¦è‡ªå·±ä¿å­˜è¿™ä¸ªå€¼ï¼Œæ­¤æ—¶ä¼šè¢«ä¿å­˜åœ¨ union u çš„ TValue value ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯å¸¸è§çš„å¯ä»¥ç”¨é—­åŒ…å®ç°è®¡æ•°å™¨çš„åŸç†ã€‚</p>
<h3 id="c-é—­åŒ…">C é—­åŒ…</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">CClosure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ClosureHeader</span><span class="p">;</span> <span class="c1">// gc ç›¸å…³å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lua_CFunction</span> <span class="n">f</span><span class="p">;</span> <span class="c1">// å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TValue</span> <span class="n">upvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* list of upvalues */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">CClosure</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€ä¸ç®¡æ˜¯è½»é‡ C å‡½æ•°è¿˜æ˜¯ C é—­åŒ…ï¼Œéƒ½æ˜¯ä½¿ç”¨ CClosure å˜é‡è¡¨ç¤ºã€‚upvalue å…¨éƒ¨æ˜¯ç”± TValue çš„å€¼ç»„æˆçš„ï¼Œä¸å­˜åœ¨ç”¨æŒ‡é’ˆçš„æƒ…å†µã€‚å½“é—­åŒ…ä¸éœ€è¦ upvalue æ—¶ï¼Œä¹Ÿå°±æ˜¯åªæœ‰å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œå°±æ˜¯è½»é‡ C å‡½æ•°äº†ã€‚</p>
<h2 id="table">table</h2>
<p>ã€€ã€€table æ˜¯ Lua ä¸­å”¯ä¸€æä¾›çš„æ•°æ®ç»“æ„ï¼Œå®ƒæ–¹ä¾¿æ˜“ç”¨ï¼Œå¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å› ä¸ºæŠŠ array å’Œ hashmap å’Œåœ¨äº†ä¸€èµ·ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿæœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚<br>
ã€€ã€€table çš„åŸºç¡€ç±»å‹æ˜¯ LUA_TTABLEï¼Œå®ƒåªæœ‰ä¸€ä¸ªå˜ç§ç±»å‹ LUA_VTABLEï¼Œvariant çš„å€¼ä¸º 0ã€‚</p>
<h3 id="ç»“æ„-1">ç»“æ„</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">union</span> <span class="n">Node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">NodeKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TValuefields</span><span class="p">;</span>  <span class="cm">/* fields for value */</span>
</span></span><span class="line"><span class="cl">        <span class="n">lu_byte</span> <span class="n">key_tt</span><span class="p">;</span>  <span class="cm">/* key type */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">next</span><span class="p">;</span>  <span class="cm">/* for chaining (offset for next node)*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">Value</span> <span class="n">key_val</span><span class="p">;</span>  <span class="cm">/* key value */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TValue</span> <span class="n">i_val</span><span class="p">;</span>  <span class="cm">/* direct access to node&#39;s value as a proper &#39;TValue&#39; */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Table</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">flags</span><span class="p">;</span>  <span class="cm">/* 1&lt;&lt;p means tagmethod(p) is not present */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lu_byte</span> <span class="n">lsizenode</span><span class="p">;</span>  <span class="cm">/* log2 of size of &#39;node&#39; array */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alimit</span><span class="p">;</span>  <span class="cm">/* &#34;limit&#34; of &#39;array&#39; array */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TValue</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>  <span class="cm">/* array part */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span> <span class="c1">// å“ˆå¸Œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Node</span> <span class="o">*</span><span class="n">lastfree</span><span class="p">;</span>  <span class="cm">/* any free position is before this position */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Table</span> <span class="o">*</span><span class="n">metatable</span><span class="p">;</span> <span class="c1">// å…ƒè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GCObject</span> <span class="o">*</span><span class="n">gclist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Table</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€ç”±äºåœ¨ table ä¸­æ•°ç»„å’Œå“ˆå¸Œè¡¨çš„æ··ç”¨ï¼Œæ‰€ä»¥åœ¨ç»“æ„ä½“ä¸­ä¼šåŒ…å«è¿™ä¸¤ç±»çš„æ•°æ®ã€‚<br>
ã€€ã€€æ•°ç»„éƒ¨åˆ†åŒ…æ‹¬äº† array å’Œ alimit è¿™ä¸¤ä¸ªå€¼ï¼Œarray æ˜¯ä¸€ä¸ª TValue ç»“æ„ä½“çš„æ•°ç»„ï¼Œalimit æ˜¯å®ƒçš„é•¿åº¦ä¸Šé™ï¼Œä¸ä¸€å®šæ˜¯çœŸå®çš„é•¿åº¦ã€‚<br>
ã€€ã€€å“ˆå¸Œè¡¨åŒ…æ‹¬äº† nodeï¼Œlsizenode å’Œ lastfree ä¸‰ä¸ªå€¼ï¼Œnode æ˜¯ä¸€ä¸ª Node ç»“æ„ä½“çš„æ•°ç»„ï¼Œlsizenode æ˜¯å®ƒçš„é•¿åº¦ä»¥ 2 ä¸ºåº•çš„å¯¹æ•°å€¼ï¼Œè¿™ä¸ªå€¼ä¹Ÿè¯´æ˜äº†å“ˆå¸Œè¡¨çš„é•¿åº¦ä¸€å®šæ˜¯ 2 çš„å¹‚ï¼Œlastfree æŒ‡å‘äº†å“ˆå¸Œè¡¨æœ€åä¸€ä¸ªä½ç½®ã€‚<br>
ã€€ã€€flags æ˜¯ä¸€ä¸ª unsigned char ç±»å‹çš„å€¼ï¼Œå®ƒé‡Œé¢çš„æ¯ä¸€ä¸ª bit å¯¹åº”äº†ä¸€ç§å…ƒæ–¹æ³•æ˜¯å¦å­˜åœ¨ï¼Œ1 è¡¨ç¤ºä¸å­˜åœ¨ï¼Œ0 è¡¨ç¤ºå­˜åœ¨ï¼ŒåŒæ—¶ bit 7 ä¿å­˜äº† alimit æ˜¯å¦æ˜¯ array çš„çœŸå®é•¿åº¦ã€‚<br>
<img src="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/table_flags.jpg"
	width="1662"
	height="362"
	srcset="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/table_flags_hu70e95380fe12c39cb02630813633b88d_43859_480x0_resize_q75_box.jpg 480w, /p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%BA%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/table_flags_hu70e95380fe12c39cb02630813633b88d_43859_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="table_flags"
	
	
		class="gallery-image" 
		data-flex-grow="459"
		data-flex-basis="1101px"
	
>
ã€€ã€€metatable æŒ‡å‘äº†è¯¥ table çš„å…ƒè¡¨ï¼Œå› ä¸ºå…ƒè¡¨ä¹Ÿæ˜¯ä¸€ä¸ª tableï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ª Table ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<br>
ã€€ã€€å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ Node ç»“æ„ä½“å˜é‡è¡¨ç¤ºï¼Œå®ƒä¸»è¦åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ï¼ŒNodeKey u å’Œ TValue i_val åˆ†åˆ«æ˜¯é”®å€¼å¯¹çš„é”®å’Œå€¼ã€‚</p>
<h3 id="åˆ›å»º">åˆ›å»º</h3>
<p>ã€€ã€€table ä¹Ÿæ˜¯ GCObjectï¼Œæ‰€ä»¥åˆ›å»ºä¸€æ ·ä½¿ç”¨ luaC_newobj å³å¯ã€‚<br>
ã€€ã€€å¯¹è±¡åˆ›å»ºå¥½ä»¥åï¼Œä½¿ç”¨ gco2t å°†å…¶è½¬åŒ–ä¸º Table ç»“æ„çš„å˜é‡ï¼Œç„¶åå°† matetable è®¾ä¸º NULLï¼Œflags çš„æ¯ä¸€ä½éƒ½è®¾ä¸º 1ï¼Œarray è®¾ä¸º NULLï¼Œalimit è®¾ä¸º 0ã€‚<br>
ã€€ã€€è¿˜è¦åˆå§‹åŒ–å“ˆå¸Œè¡¨ï¼Œå› ä¸ºä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¹Ÿæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ node åªéœ€è¦æŒ‡å‘ä¸€ä¸ªå ä½ç”¨çš„æ•°æ®å³å¯ï¼ŒLua å·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªé™æ€å˜é‡ dummynode æ¥åšè¿™ä¸ªå·¥ä½œã€‚åŒæ—¶ lsizenode è®¾ä¸º 0ï¼Œä¸”å°† lastfree è®¾ä¸º NULLï¼Œè¿™ä¸ªå¯ä»¥è¡¨ç¤ºå½“å‰ä½¿ç”¨çš„æ˜¯å ä½ nodeï¼Œæ–¹ä¾¿åç»­ä¿®æ”¹ã€‚</p>
<h3 id="æ’å…¥">æ’å…¥</h3>
<p>ã€€ã€€å¯ä»¥ä» C Api çš„ lua_settable å…¥æ‰‹çœ‹ä¸€ä¸‹å‘ table ä¸­æ’å…¥ä¸€ä¸ªå€¼çš„æ“ä½œã€‚<br>
ã€€ã€€åœ¨è®¾ç½®ä¸€ä¸ªå€¼çš„æ—¶å€™ä¼šå…ˆå°è¯•ç”¨ luaH_get å»å–è¿™ä¸ªå€¼ï¼Œå¦‚æœå¯ä»¥å–åˆ°çš„è¯ï¼Œåˆ™ç›´æ¥ä¿®æ”¹å®ƒå°±è¡Œäº†ï¼Œå¦‚æœå–ä¸åˆ°ï¼Œåˆ™ä¼šé¦–å…ˆæŠŠ slot æŒ‡å‘ç”¨æ¥å ä½çš„ static å˜é‡ absentkeyï¼Œç„¶åè°ƒç”¨ luaV_finishset æ–°å¢ä¸€ä¸ªå€¼ã€‚<br>
ã€€ã€€åœ¨ luaV_finishset ä¸­ï¼Œä¼šå…ˆé€šè¿‡æ£€æŸ¥ metatable å’Œ flags åˆ¤æ–­ table æ˜¯å¦æœ‰ __newindex å…ƒæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä½¿ç”¨ luaH_finishset è®¾ç½®é”®å€¼å¯¹ï¼Œå½“ slot æ˜¯ absentkey æ—¶ï¼Œæœ€åä¼šä½¿ç”¨ luaH_newkey åˆ›å»ºä¸€ä¸ªæ–°é”®å€¼å¯¹ã€‚<br>
ã€€ã€€table çš„å“ˆå¸Œéƒ¨åˆ†è§£å†³å†²çªä½¿ç”¨çš„æ˜¯å¼€æ”¾å®šå€æ³•ï¼Œæœ‰ä¸€ä¸ª mainposition çš„æ¦‚å¿µï¼Œå®ƒæ˜¯é€šè¿‡è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œä¸å½“å‰ table çš„ lsizenode å–æ¨¡çš„å‡ºæ¥çš„ã€‚<br>
ã€€ã€€å½“é€šè¿‡ key æ‹¿åˆ° mainposition ä»¥åæŠŠå®ƒä¿å­˜åœ¨ mp ä¸­ï¼Œç„¶åä¼šåˆ¤æ–­ mp æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥æŠŠè¦å­˜çš„å€¼å­˜åœ¨ mp ä¸Šå³å¯ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™ä¼šæ‹¿ mp çš„ key å†å»è®¡ç®—ä¸€æ¬¡ mainpositon ä¿å­˜ä¸º othernï¼Œè¿™ä¸€æ­¥æ˜¯è¦åˆ¤æ–­å½“å‰åœ¨æœ¬ä½åˆ¶ä¸Šçš„å€¼æ˜¯ä¸æ˜¯é€šè¿‡å“ˆå¸Œè®¡ç®—æ¥çš„ã€‚<br>
ã€€ã€€å¦‚æœæ˜¯é€šè¿‡å“ˆå¸Œè®¡ç®—æ¥çš„ï¼Œé‚£å°±æ˜¯åœ¨æœ¬ä½ç½®ä¸Šå‘ç”Ÿäº†å†²çªï¼Œä» table çš„ lastfree ä¸Šæ‰¾åˆ°ä¸€ä¸ªç©ºä½™çš„ç‚¹ fï¼Œå°† f çš„ next è®¾ä¸º mp çš„ nextï¼Œç„¶åå°† mp çš„ next è®¾ä¸º fï¼Œä¹Ÿå°±æ˜¯å°† f é“¾æ¥åˆ°äº† mp çš„åé¢ï¼Œæœ€åå°†å€¼ä¿å­˜åœ¨ f ä¸­å³å¯å®Œæˆã€‚<br>
ã€€ã€€å¦‚æœä¸æ˜¯å“ˆå¸Œè®¡ç®—æ¥çš„ï¼Œåˆ™è¯´æ˜å®ƒæ˜¯é€šè¿‡ getfreepos è·å–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå äº†æˆ‘ä»¬ç°åœ¨è¦å­˜çš„è¿™ä¸ª key çš„ä½ç½®ï¼Œè¿™æ—¶å€™è¦å°†å®ƒç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„ freepos ä¸­ã€‚å› ä¸ºå®ƒçš„ mainposition æ˜¯ othernï¼Œæ‰€ä»¥å®ƒç°åœ¨çš„ä½ç½® mp æ˜¯ä¸€å®šåœ¨ othern çš„ next é“¾ä¸Šçš„ï¼Œå› ä¸ºå®ƒä¹‹æ‰€ä»¥åœ¨è¿™é‡Œï¼Œå°±æ˜¯å› ä¸ºè·Ÿ othern çš„ä½ç½®å†²çªå¯¼è‡´çš„ã€‚é€šè¿‡ othern ä¸æ–­å‘åéå†æ‰¾åˆ° mp çš„ä½ç½®ï¼Œç„¶åå°† othern çš„ next æŒ‡å‘ fï¼Œå°† *mp å¤åˆ¶åˆ° *f ä¸Šï¼Œè¿™æ ·å°±å®Œæˆäº† mp ä¸Šçš„æ•°æ®è½¬ç§»ï¼Œç„¶åå°†æ•°æ®ä¿å­˜åœ¨ mp ä¸Šå³å¯ã€‚<br>
ã€€ã€€ä¸Šé¢å®Œæˆçš„æ˜¯é”®å€¼å¯¹çš„æ–°å¢ï¼Œè‡³äºæ•°ç»„éƒ¨åˆ†ï¼Œå½“ key æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–è€…æ˜¯å¯ä»¥è½¬åŒ–ä¸ºæ•´æ•°çš„æµ®ç‚¹æ•°æ—¶ï¼Œåœ¨æŸ¥æ‰¾ key çš„æ—¶å€™ä¼šæ£€æŸ¥ key çš„èŒƒå›´ï¼Œå¦‚æœ key åœ¨ [1, t-&gt;alimit] ä¸­ï¼Œåˆ™ç›´æ¥è¿”å› table ä¸­ array æ•°ç»„å¯¹åº”çš„å€¼ã€‚å¦‚æœå½“å‰ t çš„ array é•¿åº¦è·Ÿ alimit ä¸ç­‰çš„è¯ï¼Œkey ç­‰äº alimit + 1ï¼Œæˆ–è€… key å°äº luaH_realasize è®¡ç®—å‡ºçš„å€¼ï¼ŒåŒæ ·è¿”å› array ä¸­å¯¹åº”çš„å€¼ï¼Œå¹¶ä¸”æŠŠ alimit è®¾ç½®ä¸º key çš„å€¼ã€‚key æ»¡è¶³åœ¨æ•°ç»„éƒ¨åˆ†çš„æ—¶å€™ï¼Œç›´æ¥ä¿®æ”¹å³å¯ã€‚</p>
<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>
<p>ã€€ã€€ä» lua_gettable å…¥æ‰‹æ¥çœ‹ä¸€ä¸‹åœ¨ table ä¸­æŸ¥è¯¢ä¸€ä¸ªæŒ‡å®š key çš„å€¼çš„æ“ä½œã€‚<br>
ã€€ã€€é¦–å…ˆé€šè¿‡ luaH_get æ¥æŸ¥æ‰¾ key å¯¹åº”çš„å€¼ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ç›´æ¥è¿”å›å³å¯ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šè°ƒç”¨ luaV_finishgetï¼Œå…¶ä¸­ä¼šæ£€æŸ¥ __index å…ƒæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰è¯¥å…ƒæ–¹æ³•çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å› nil å³å¯ã€‚<br>
ã€€ã€€å¦‚æœ __index å…ƒæ–¹æ³•æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒï¼Œå°†ç»“æœè¿”å›ã€‚å¦‚æœæ˜¯ä¸€ä¸ª table åˆ™å†æ¬¡ä½¿ç”¨ luaH_get å°è¯•è¿”å›å…ƒè¡¨ä¸­ key å¯¹åº”çš„å€¼ã€‚</p>
<h3 id="é•¿åº¦">é•¿åº¦</h3>
<p>ã€€ã€€Lua ä¸­å¦‚æœå¯¹ table å–é•¿åº¦ï¼Œåˆ™åªä¼šæ‹¿åˆ°æ•°ç»„éƒ¨åˆ†çš„é•¿åº¦ï¼Œè€Œä¸”å¦‚æœ table æ˜¯æ•°ç»„å’Œå“ˆå¸Œè¡¨æ··ç”¨çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé•¿åº¦å¯èƒ½ä¼šæœ‰ç‚¹é—®é¢˜ã€‚ä» lua_len å…¥æ‰‹æ¥çœ‹ä¸€ä¸‹å– table é•¿åº¦çš„æ“ä½œã€‚<br>
ã€€ã€€lua_len ä¼šè°ƒç”¨ luaV_objlen å¯¹å˜é‡å–é•¿åº¦ã€‚å½“ç±»å‹æ˜¯ table çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå–å…¶ __len å…ƒæ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨å®ƒè¿”å›ç»“æœå³å¯ã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼Œä¼šè°ƒç”¨ luaH_getn æ¥è®¡ç®— table çš„é•¿åº¦ã€‚<br>
ã€€ã€€luaH_getn çš„é€»è¾‘ä¸é•¿ï¼Œä½†æ˜¯æ€è·¯æ¯”è¾ƒå¤æ‚ï¼ŒLua çš„æºç ä¸­åœ¨å‡½æ•°å¤´ç»™å‡ºäº† 30 è¡Œçš„æ³¨é‡Šæ¥æè¿°è¿™ä¸ªå‡½æ•°çš„ä½œç”¨åŸç†ï¼Œæˆ‘å°è¯•æŠŠå®ƒçš„å¤§æ„ç¿»è¯‘å‡ºæ¥ã€‚</p>
<blockquote>
<p>ã€€ã€€å°è¯•æ‰¾åˆ° table t çš„è¾¹ç•Œï¼Œè¾¹ç•Œæ˜¯ä¸€ä¸ªæ•´æ•°ç´¢å¼•ï¼Œä¾‹å¦‚ t[i] å­˜åœ¨ä½†æ˜¯ t[i+1] ä¸å­˜åœ¨æ—¶ i å°±æ˜¯ t çš„è¾¹ç•Œï¼Œæˆ–è€…å½“ t[1] ä¸å­˜åœ¨æ—¶ 0 å°±æ˜¯ t çš„è¾¹ç•Œï¼Œå½“ t[maxinteger] å­˜åœ¨æ—¶ï¼Œmaxinteger å°±æ˜¯ t çš„è¾¹ç•Œã€‚<br>
ã€€ã€€(1). å¦‚æœ t[limit] ä¸ºç©ºï¼Œåˆ™å®ƒä¸€å®šæœ‰ä¸€ä¸ªåœ¨å®ƒå‰é¢çš„è¾¹ç•Œï¼Œè¿™æ—¶å€™å¯ä»¥æ£€æŸ¥ limit - 1 æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å®ƒæ˜¯ t çš„è¾¹ç•Œã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åœ¨ [0, limit] ä¸Šåšä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾æ¥å¯»æ‰¾è¾¹ç•Œã€‚è¿™ä¸¤ç§æƒ…å†µä¸‹æ‰¾åˆ°è¾¹ç•Œä»¥åéƒ½è¦æ›´æ–° t çš„ alimit å­—æ®µã€‚<br>
ã€€ã€€(2). å¦‚æœ t[limit] ä¸ä¸ºç©ºï¼ŒåŒæ—¶æ•°ç»„ä¸­æœ‰åœ¨ limit ä¹‹åçš„æ•°æ®æ—¶ï¼Œä¹Ÿå¯ä»¥æ‰¾å‡º t çš„è¾¹ç•Œã€‚å¦‚æœ t[limit + 1] ä¸ºç©ºï¼Œåˆ™ limit å°±æ˜¯è¾¹ç•Œï¼Œå¦åˆ™æ£€æŸ¥æ•°ç»„éƒ¨åˆ†çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœå®ƒæ˜¯ç©ºï¼Œåˆ™è¾¹ç•Œä¸€å®šå­˜åœ¨äº limit å’Œæœ€åä¸€ä¸ªå…ƒç´ ä¹‹é—´ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ‰¾å‡ºæ¥ã€‚<br>
ã€€ã€€(3). æœ€åä¸€ç§æƒ…å†µæ˜¯ t çš„æ•°ç»„éƒ¨åˆ†ä¸ºç©ºï¼Œæˆ–è€…å®ƒçš„æœ€åä¸€ä¸ªå…ƒç´ å­˜åœ¨ã€‚è¿™ä¸¤ç§æƒ…å†µä¸‹éœ€è¦æ£€æŸ¥å“ˆå¸Œéƒ¨åˆ†ã€‚å¦‚æœå“ˆå¸Œéƒ¨åˆ†ä¹Ÿä¸ºç©ºï¼Œæˆ–è€… limit + 1 ä¸å­˜åœ¨ï¼Œåˆ™ limit ä¸ºè¾¹ç•Œã€‚å¦åˆ™é€šè¿‡ hash_search æŸ¥æ‰¾åœ¨å“ˆå¸Œéƒ¨åˆ†çš„è¾¹ç•Œã€‚</p>
</blockquote>
<p>ã€€ã€€é•¿åº¦è®¡ç®—éå¸¸å¤æ‚ï¼Œæ‰€ä»¥åœ¨å¼€å‘ä¸­æ°¸è¿œä¸è¦åœ¨ä¸€ä¸ª table é‡Œæ··ç”¨ array å’Œ mapã€‚æˆ‘è§‰å¾— Lua åº”è¯¥å½»åº•åˆ†å¼€è¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œæ··åˆè¿™ä¸¤ç±»æ•°æ®ç»“æ„ï¼Œè¡¨é¢ä¸Šçœ‹æ˜¯é™ä½äº†é—¨æ§›ï¼Œå…¶å®æˆ‘è®¤ä¸ºåè€Œæ˜¯æé«˜äº†éšæ€§çš„ä½¿ç”¨é—¨æ§›ã€‚</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/lua/">lua</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-contents--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-contents">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/lua-%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8A%A0%E8%BD%BD%E5%92%8C%E7%83%AD%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/">
        
        

        <div class="article-details">
            <h2 class="article-title">Lua çš„ä»£ç åŠ è½½å’Œçƒ­æ›´æ–°æ–¹å¼</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/%E5%A6%82%E4%BD%95%E5%B0%86%E4%B8%80%E4%B8%AA-lua-table-%E5%BA%8F%E5%88%97%E5%8C%96/">
        
        

        <div class="article-details">
            <h2 class="article-title">å¦‚ä½•å°†ä¸€ä¸ª Lua Table åºåˆ—åŒ–</h2>
        </div>
    </a>
</article>
            
                
<article class="">
    <a href="/p/lua%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%E4%B8%80%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/">
        
        

        <div class="article-details">
            <h2 class="article-title">Luaæºç ç¬”è®°ï¼ˆä¸€ï¼‰ä»£ç ç»“æ„</h2>
        </div>
    </a>
</article>
            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="medetasi/homurua.github.io"
        issue-term="pathname"
        
        label="blog-comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2022 æ”¾å­¦åèŒ¶ä¼š
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.10.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#tvalue">TValue</a></li>
    <li><a href="#gcunion--gcobject">GCUnion &amp;&amp; GCObject</a></li>
    <li><a href="#åˆ›å»º-gcobject">åˆ›å»º GCObject</a></li>
    <li><a href="#nil">nil</a></li>
    <li><a href="#boolean">boolean</a></li>
    <li><a href="#number">number</a></li>
    <li><a href="#userdata">userdata</a></li>
    <li><a href="#thread">thread</a></li>
    <li><a href="#string">string</a>
      <ol>
        <li><a href="#ç»“æ„">ç»“æ„</a></li>
        <li><a href="#å…¨å±€å­—ç¬¦ä¸²è¡¨">å…¨å±€å­—ç¬¦ä¸²è¡¨</a></li>
        <li><a href="#åˆ›å»ºå­—ç¬¦ä¸²">åˆ›å»ºå­—ç¬¦ä¸²</a></li>
        <li><a href="#çŸ­å­—ç¬¦ä¸²">çŸ­å­—ç¬¦ä¸²</a></li>
        <li><a href="#é•¿å­—ç¬¦ä¸²">é•¿å­—ç¬¦ä¸²</a></li>
        <li><a href="#æ¯”è¾ƒå­—ç¬¦ä¸²">æ¯”è¾ƒå­—ç¬¦ä¸²</a></li>
        <li><a href="#ä¿ç•™å­—ç¬¦ä¸²">ä¿ç•™å­—ç¬¦ä¸²</a></li>
      </ol>
    </li>
    <li><a href="#proto">proto</a></li>
    <li><a href="#function">function</a>
      <ol>
        <li><a href="#lua-é—­åŒ…">Lua é—­åŒ…</a></li>
        <li><a href="#c-é—­åŒ…">C é—­åŒ…</a></li>
      </ol>
    </li>
    <li><a href="#table">table</a>
      <ol>
        <li><a href="#ç»“æ„-1">ç»“æ„</a></li>
        <li><a href="#åˆ›å»º">åˆ›å»º</a></li>
        <li><a href="#æ’å…¥">æ’å…¥</a></li>
        <li><a href="#æŸ¥è¯¢">æŸ¥è¯¢</a></li>
        <li><a href="#é•¿åº¦">é•¿åº¦</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<style>
     
</style>

<script>
		
		
		
		
		
		
		
		
		
</script>


    </body>
</html>

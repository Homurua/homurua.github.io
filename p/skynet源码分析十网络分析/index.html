<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ã€€ç½‘ç»œç›¸å…³çš„éƒ¨åˆ†æ˜¯æˆ‘æ„Ÿè§‰ skynet ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†äº†ï¼Œæœ¬ç¯‡ä¸­ä¼šå°è¯•å°½é‡å®Œæ•´çš„åˆ†æåˆ°ç½‘ç»œç›¸å…³çš„å¤§éƒ¨åˆ†åŠŸèƒ½çš„å®ç°åŸç†ã€‚
'><title>skynetæºç åˆ†æï¼ˆåï¼‰ç½‘ç»œåˆ†æ</title>

<link rel='canonical' href='https://wmf.im/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.e2f1b0a7c117e0132d2bfedd61d7ce82c7bd6daae147284607d15b4402c78602.css"><meta property='og:title' content='skynetæºç åˆ†æï¼ˆåï¼‰ç½‘ç»œåˆ†æ'>
<meta property='og:description' content='ã€€ç½‘ç»œç›¸å…³çš„éƒ¨åˆ†æ˜¯æˆ‘æ„Ÿè§‰ skynet ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†äº†ï¼Œæœ¬ç¯‡ä¸­ä¼šå°è¯•å°½é‡å®Œæ•´çš„åˆ†æåˆ°ç½‘ç»œç›¸å…³çš„å¤§éƒ¨åˆ†åŠŸèƒ½çš„å®ç°åŸç†ã€‚
'>
<meta property='og:url' content='https://wmf.im/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='æ”¾å­¦åèŒ¶ä¼š'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='skynet' /><meta property='article:published_time' content='2022-02-18T14:53:02&#43;08:00'/><meta property='article:modified_time' content='2022-02-18T14:53:02&#43;08:00'/>
<meta name="twitter:title" content="skynetæºç åˆ†æï¼ˆåï¼‰ç½‘ç»œåˆ†æ">
<meta name="twitter:description" content="ã€€ç½‘ç»œç›¸å…³çš„éƒ¨åˆ†æ˜¯æˆ‘æ„Ÿè§‰ skynet ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†äº†ï¼Œæœ¬ç¯‡ä¸­ä¼šå°è¯•å°½é‡å®Œæ•´çš„åˆ†æåˆ°ç½‘ç»œç›¸å…³çš„å¤§éƒ¨åˆ†åŠŸèƒ½çš„å®ç°åŸç†ã€‚
">
    <link rel="shortcut icon" href="/img/dango.svg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar2_hu982b126fde96804c253e53a1f123b818_111741_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¡</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ”¾å­¦åèŒ¶ä¼š</a></h1>
            <h2 class="site-description">Please don&#39;t say &#34;You are lazy&#34;</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/medetasi'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E6%94%BE%E5%AD%A6%E5%90%8E%E8%8C%B6%E4%BC%9A/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/skynet%E7%AC%94%E8%AE%B0/" style="background-color: #46BDBA; color: #fff;">
                skynetç¬”è®°
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90/">skynetæºç åˆ†æï¼ˆåï¼‰ç½‘ç»œåˆ†æ</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 18, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 17 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p>ã€€ã€€ç½‘ç»œç›¸å…³çš„éƒ¨åˆ†æ˜¯æˆ‘æ„Ÿè§‰ skynet ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†äº†ï¼Œæœ¬ç¯‡ä¸­ä¼šå°è¯•å°½é‡å®Œæ•´çš„åˆ†æåˆ°ç½‘ç»œç›¸å…³çš„å¤§éƒ¨åˆ†åŠŸèƒ½çš„å®ç°åŸç†ã€‚</p>
<h2 id="çº¿ç¨‹æ¨¡å‹">çº¿ç¨‹æ¨¡å‹</h2>
<p>ã€€ã€€skynet ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹æ˜¯å¤šçº¿ç¨‹ reactor æ¨¡å‹ï¼Œæœ‰ä¸€æ¡ socket çº¿ç¨‹ç”¨æ¥æ¥æ”¶ epoll äº‹ä»¶ï¼Œå¹¶ä¸”è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œæœ‰å¤šæ¡ worker çº¿ç¨‹æ¥æ‰§è¡Œäº‹ä»¶ã€‚<br>
ã€€ã€€ä¸å…¶å®ƒä½¿ç”¨ç±»ä¼¼æ¨¡å‹çš„æ¡†æ¶ç›¸æ¯”ï¼Œskynet æœ€å¤§çš„åŒºåˆ«åº”è¯¥å°±æ˜¯è¿˜ä½¿ç”¨äº† Actor çš„å¹¶å‘æ¨¡å‹ã€‚socket çº¿ç¨‹åœ¨å¤„ç† epoll äº‹ä»¶çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æŠŠäº‹ä»¶äº¤ç»™äº† worker çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè€Œæ˜¯æŠŠäº‹ä»¶å’Œç›¸å…³çš„æ•°æ®ä¸€èµ·è½¬åŒ–ä¸ºä¸€æ¡ Actor ä¹‹é—´é€šç”¨çš„æ¶ˆæ¯ï¼Œæ”¾åˆ°äº†ç›®æ ‡ Actor çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·ç­‰åˆ° worker çº¿ç¨‹å¤„ç† Actor çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè‡ªç„¶ä¼šå¤„ç†è¿™ä¸ªç½‘ç»œäº‹ä»¶ã€‚</p>
<h2 id="socket-ç®¡ç†å™¨">socket ç®¡ç†å™¨</h2>
<h3 id="ç»“æ„åˆ†æ">ç»“æ„åˆ†æ</h3>
<p>ã€€ã€€æ¯ä¸ª skynet è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„ socket ç®¡ç†å™¨ï¼Œå®ƒç®¡ç†äº†æ•´ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰ socket è¿æ¥ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹å®ƒå†…éƒ¨çš„ç»“æ„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define MAX_INFO 128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// MAX_SOCKET will be 2^MAX_SOCKET_P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MAX_SOCKET_P 16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_SOCKET (1&lt;&lt;MAX_SOCKET_P)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_EVENT 64
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_UDP_PACKAGE 65535
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">socket_server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">volatile</span> <span class="kt">uint64_t</span> <span class="n">time</span><span class="p">;</span> <span class="c1">// æ—¶é—´ï¼Œç”± timer çº¿ç¨‹æ›´æ–°ï¼Œsocket çº¿ç¨‹ç›´æ¥è¯»è¿™ä¸ªå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">recvctrl_fd</span><span class="p">;</span> <span class="c1">// æ¥æ”¶å‘½ä»¤çš„ç®¡é“å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">sendctrl_fd</span><span class="p">;</span> <span class="c1">// å‘é€å‘½ä»¤çš„ç®¡é“å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">checkctrl</span><span class="p">;</span> <span class="c1">// ç”¨æ¥æ ‡è®°æ˜¯å¦è¦æ£€æŸ¥æ§åˆ¶å°å‘½ä»¤çš„æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">poll_fd</span> <span class="n">event_fd</span><span class="p">;</span> <span class="c1">// å…¨å±€çš„ epoll å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ATOM_INT</span> <span class="n">alloc_id</span><span class="p">;</span> <span class="c1">// å·²åˆ†é…çš„idï¼Œä¸æ–­ç´¯åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">event_n</span><span class="p">;</span> <span class="c1">// æœ¬æ¬¡è°ƒç”¨ epoll å¾—åˆ°çš„å°±ç»ªçš„ fd ä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">event_index</span><span class="p">;</span> <span class="c1">// ç›®å‰å¤„ç†åˆ°çš„ fd åºå·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">socket_object_interface</span> <span class="n">soi</span><span class="p">;</span> <span class="c1">// userobject æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">event</span> <span class="n">ev</span><span class="p">[</span><span class="n">MAX_EVENT</span><span class="p">];</span> <span class="c1">// æ•è·çš„äº‹ä»¶æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">socket</span> <span class="n">slot</span><span class="p">[</span><span class="n">MAX_SOCKET</span><span class="p">];</span> <span class="c1">// å…¨éƒ¨çš„ socket å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_INFO</span><span class="p">];</span> <span class="c1">// ä¸´æ—¶ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">udpbuffer</span><span class="p">[</span><span class="n">MAX_UDP_PACKAGE</span><span class="p">];</span> <span class="c1">// udp æ•°æ®ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fd_set</span> <span class="n">rfds</span><span class="p">;</span> <span class="c1">// è¦ç›‘å¬çš„è¯»æè¿°ç¬¦é›†åˆï¼Œç”¨äºå‘½ä»¤çš„ select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€å„ä¸ªå˜é‡çš„ä½œç”¨å·²ç»åœ¨æ³¨é‡Šä¸­å†™å‡ºï¼Œè¿™äº›å˜é‡å…·ä½“çš„ä½¿ç”¨ä¼šåœ¨åé¢çš„å®ç°åˆ†æä¸­çœ‹åˆ°ï¼Œå¤§æ¦‚ç”± epoll ç›¸å…³çš„å˜é‡ï¼Œsocket ç›¸å…³çš„å˜é‡ï¼Œpipe fd ç›¸å…³çš„å˜é‡ç»„æˆã€‚</p>
<h3 id="ç»“æ„åˆå§‹åŒ–">ç»“æ„åˆå§‹åŒ–</h3>
<p>ã€€ã€€å½“æœåŠ¡å™¨è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œåœ¨ä¹‹å‰æ–‡ç« æåˆ°è¿‡çš„å¯åŠ¨å‡½æ•° <code>skynet_start</code> ä¼šè¢«è°ƒç”¨ï¼Œå®ƒåˆä¼šè°ƒç”¨ <code>socket_server_create</code> æ¥åˆ›å»ºä¸€ä¸ªå…¨å±€çš„ <code>socket_server</code> å¯¹è±¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">socket_server</span> <span class="o">*</span><span class="nf">socket_server_create</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºç”¨äºå‘½ä»¤çš„ç®¡é“å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º epoll å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">poll_fd</span> <span class="n">efd</span> <span class="o">=</span> <span class="nf">sp_create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥åˆ›å»ºæ˜¯å¦æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">sp_invalid</span><span class="p">(</span><span class="n">efd</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skynet_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;socket-server: create event pool failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºç®¡é“ï¼Œè¿™é‡Œå¹¶æœªå°†ç®¡é“çš„å¥—æ¥å­—è®¾ä¸ºéé˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">pipe</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sp_release</span><span class="p">(</span><span class="n">efd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skynet_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;socket-server: create socket pair failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠ fd[0] åŠ å…¥åˆ° epoll çš„ç®¡ç†ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">sp_add</span><span class="p">(</span><span class="n">efd</span><span class="p">,</span> <span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// add recvctrl_fd to event poll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">skynet_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;socket-server: can&#39;t add server fd to event pool.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sp_release</span><span class="p">(</span><span class="n">efd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºç»“æ„ä½“å¹¶è¿›è¡Œä¸€äº›åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">socket_server</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="nf">MALLOC</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">event_fd</span> <span class="o">=</span> <span class="n">efd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">recvctrl_fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">sendctrl_fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">checkctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¡«å…… socket ç®¡ç†å™¨çš„å¥—æ¥å­—æ’æ§½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SOCKET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–è¿æ¥çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ATOM_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">SOCKET_TYPE_INVALID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ¸…ç©ºé«˜ä¼˜å…ˆçº§ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">clear_wb_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ¸…ç©ºä½ä¼˜å…ˆçº§ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">clear_wb_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">spinlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dw_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ATOM_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">alloc_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">event_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">event_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">soi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">soi</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¸…ç©ºç›‘å¬æè¿°ç¬¦é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">rfds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">recvctrl_fd</span> <span class="o">&lt;</span> <span class="n">FD_SETSIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€è™½ç„¶å‡½æ•°æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯åšçš„äº‹æƒ…è¿˜æ˜¯å¾ˆç®€å•çš„ï¼ŒåŸºæœ¬å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª <code>socket_server</code> ç±»å‹çš„å˜é‡ï¼Œç„¶ååˆå§‹åŒ–å®ƒï¼Œæœ€åè¿”å›ï¼Œæ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ­¥éª¤å¦‚ä¸‹ã€‚</p>
<ul>
<li>åˆ›å»ºäº†ç”¨äº ctrl å‘½ä»¤çš„ç®¡é“å¥—æ¥å­— fd[0] å’Œ fd[1]</li>
<li>åˆ›å»ºäº† epoll å¥—æ¥å­—</li>
<li>å°†ç®¡é“çš„æ¥æ”¶ç«¯åŠ å…¥ epoll å¥—æ¥å­—çš„ç®¡ç†ä¸­</li>
<li>åˆå§‹åŒ– <code>slot</code> æ•°ç»„ä¸­çš„å…¨éƒ¨æ•°æ®</li>
</ul>
<p>ã€€ã€€ç¨å¾®éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ <code>slot</code> æ•°ç»„ï¼Œå®ƒçš„æ€»é•¿åº¦æ˜¯ <code>MAX_SOCKET</code> ä¹Ÿå°±æ˜¯ 65535ï¼Œå®ƒçš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œåœ¨ä¸€å¼€å§‹è¢«åˆå§‹åŒ–ï¼Œä¹Ÿä¸ä¼šæ‰©å®¹ï¼Œè¿™æ„å‘³ç€å•ä¸ª skynet è¿›ç¨‹æ”¯æŒçš„è¿æ¥ä¸Šé™æ˜¯ 65535 ä¸ªï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯å¤Ÿç”¨äº†ã€‚</p>
<h3 id="epoll-ç›¸å…³">epoll ç›¸å…³</h3>
<p>ã€€ã€€skynet åªæä¾›äº†ä¸¤ä¸ªå¹³å°çš„å…¼å®¹æ€§ï¼ŒLinux å’Œ MacOSï¼Œä¸ºäº†å…¼å®¹è¿™ä¸¤ä¸ªå¹³å°ï¼Œæ‰€ä»¥åœ¨ IO å¤ç”¨çš„ç³»ç»Ÿæ¥å£è¿™è¾¹è‚¯å®šä¼šåšä¸€æ¬¡ä¸Šå±‚çš„å°è£…ã€‚ç…§ä¾‹æ˜¯åœ¨ Linux ä¸‹ä½¿ç”¨ <code>epoll</code>ï¼Œåœ¨ MacOS ä¸‹ä½¿ç”¨ <code>kqueue</code>ï¼Œæœ¬æ–‡åªå…³æ³¨ <code>epoll</code> çš„éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä¸ä¼š <code>kqueue</code>ï¼Œ233ã€‚<br>
ã€€ã€€æ‰€æœ‰å…³äº IO å¤ç”¨çš„æ¥å£éƒ½åœ¨æ–‡ä»¶ <code>socket_poll.h</code> ä¸­å°è£…ï¼Œç”¨çš„æ˜¯æˆ‘éå¸¸ä¸å–œæ¬¢çš„å…ˆå®šä¹‰æ¥å£ï¼Œç„¶åå†æ ¹æ®å®é€‰æ‹© include å“ªä¸ªå¤´æ–‡ä»¶çš„æ–¹æ³•å®ç°ï¼Œè¿™ç§æ–¹æ³•å¯¹æ‰€æœ‰ä»£ç æç¤ºå™¨éƒ½æ˜¯ç¾éš¾ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">sp_invalid</span><span class="p">(</span><span class="n">poll_fd</span> <span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">poll_fd</span> <span class="nf">sp_create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_release</span><span class="p">(</span><span class="n">poll_fd</span> <span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_add</span><span class="p">(</span><span class="n">poll_fd</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ud</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_del</span><span class="p">(</span><span class="n">poll_fd</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_enable</span><span class="p">(</span><span class="n">poll_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ud</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">read_enable</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">write_enable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_wait</span><span class="p">(</span><span class="n">poll_fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_nonblocking</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€ä¸Šé¢çš„è¿™äº›å°±æ˜¯ skynet æä¾›çš„ IO å¤ç”¨çš„æ‰€æœ‰æ¥å£äº†ï¼Œå…·ä½“å®ç°å°±ä¸å±•å¼€èŠäº†ï¼Œéƒ½æ˜¯å¯¹ epoll çš„æ¥å£è¿›è¡Œçš„ç®€å•å°è£…è€Œå·²ã€‚<br>
ã€€ã€€é¡ºå¸¦æä¸€å¥ skynet ä½¿ç”¨ epoll çš„æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ï¼Œè¿™ä¸€ç‚¹è·Ÿå¤§éƒ¨åˆ†å…¶å®ƒæ¡†æ¶çš„å®ç°éƒ½ä¸€è‡´ã€‚</p>
<h3 id="self-pipe">self-pipe</h3>
<p>ã€€ã€€ä» <code>socket_server</code> çš„åˆå§‹åŒ–å‡½æ•° <code>socket_server_create</code> ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>recvctrl_fd</code> å’Œ <code>sendctrl_fd</code> åˆ†åˆ«æ˜¯ç®¡é“ pipe å¥—æ¥å­—çš„ä¸¤ç«¯ï¼Œå¹¶ä¸” <code>recvctrl_fd</code> è¢«åŠ å…¥åˆ°äº† epoll ç›‘å¬ä¸­ã€‚<br>
ã€€ã€€è¿™ç”¨åˆ°äº†ä¸€ä¸ªå«åš <code>self-pipe</code> çš„æŠ€æœ¯ï¼Œã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹65.5.2 æœ‰ä»‹ç»è¿™ä¸ªæŠ€æœ¯ã€‚å®ƒåœ¨ skynet ä¸­çš„åº”ç”¨ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å•ç½‘ç»œçº¿ç¨‹é˜»å¡åœ¨ epoll çš„ wait ä¸Šè¿™ç§æƒ…å†µã€‚<br>
ã€€ã€€å½“ socket çº¿ç¨‹é˜»å¡åœ¨ <code>epoll_wait</code> ä¸Šæ—¶ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ epoll çš„ç›‘å¬äº‹ä»¶åˆ—è¡¨ï¼Œæ¯”å¦‚è¯´æƒ³è¦ä½¿ç”¨ <code>epoll_ctl</code> å¢åŠ ä¸€ä¸ªæ–°çš„ç›‘å¬äº‹ä»¶ï¼Œé‚£ä¹ˆå¤§ä½“ä¸Šæœ‰ä¸‰ç§æ–¹æ³•ã€‚</p>
<ol>
<li>åœ¨è°ƒç”¨ <code>epoll_wait</code> æ—¶è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿™æ ·åšçš„è¯ï¼Œå¯ä»¥è®© socket çº¿ç¨‹æ¯è¿‡ä¸€æ®µæ—¶é—´ä» <code>epoll_wait</code> ä¸­è§£æ”¾å‡ºæ¥ï¼Œæ¥è¿›è¡Œéœ€è¦çš„æ“ä½œï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>epoll_wait</code> é™·å…¥é˜»å¡ä¸­ã€‚</li>
<li>ä½¿ç”¨ worker çº¿ç¨‹ç›´æ¥è°ƒç”¨ <code>epoll_ctl</code> å¯¹ç›‘å¬çš„äº‹ä»¶é›†è¿›è¡Œä¿®æ”¹ï¼Œæ˜¯çš„ï¼Œ<strong><code>epoll</code> çš„ç›‘å¬äº‹ä»¶é›†æ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼Œå¯ä»¥ä¸€ä¸ªçº¿ç¨‹é˜»å¡åœ¨ <code>epoll_wait</code> ä¸Šï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº‹ä»¶é›†ã€‚</li>
<li>å°†ä¸€ä¸ªä¸“é—¨ç”¨äºæ¥æ”¶äº‹ä»¶ä¿®æ”¹å‘½ä»¤çš„å¥—æ¥å­—åŠ å…¥åˆ° epoll çš„ç›‘å¬ä¸­ï¼Œå½“éœ€è¦è¿›è¡Œæ“ä½œæ—¶ï¼Œå‘å¥—æ¥å­—ä¸­å†™å…¥å‘½ä»¤ï¼Œè¿™æ ·æ¥æ”¶ç«¯ä¼šå˜å¾—å¯è¯»ï¼Œç„¶å socket çº¿ç¨‹ä¼šä» <code>epoll_wait</code> ä¸­è¢«å”¤é†’ã€‚</li>
</ol>
<p>ã€€ã€€é¦–å…ˆç¬¬ä¸€ç§åŸºæœ¬å¯ä»¥ç›´æ¥è¢« pass äº†ï¼Œå› ä¸ºå®ƒæ³¨å®šä¼šæœ‰é¢å¤–çš„ CPU æ¶ˆè€—ï¼Œå¾ˆéš¾ç¡®å®šä¸€ä¸ªåˆé€‚çš„è¶…æ—¶æ—¶é—´ã€‚ç„¶åç¬¬äºŒç§çœ‹èµ·æ¥åº”è¯¥æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆéƒ½æ²¡ä»€ä¹ˆäººç”¨ï¼Œè²Œä¼¼æ˜¯å› ä¸ºæ—©æœŸç‰ˆæœ¬çš„å†…æ ¸å¯¹è¿™ä¸ªæ”¯æŒçš„ä¸å¥½å§ã€‚ç¬¬ä¸‰ç§å°±æ˜¯æœ€å¸¸ç”¨çš„äº†ï¼Œä¹Ÿæ˜¯ skynet çš„åšæ³•ï¼Œè¿™é‡Œç”¨äºæ¥æ”¶å‘½ä»¤çš„å¥—æ¥å­—å¾ˆå¤šæ¡†æ¶éƒ½ä¼šä½¿ç”¨ç®¡é“æ¥å®ç°ï¼Œç®€å•ä¸€äº›ã€‚</p>
<h2 id="socket-ç»“æ„ä½“">socket ç»“æ„ä½“</h2>
<h3 id="ç»“æ„åˆ†æ-1">ç»“æ„åˆ†æ</h3>
<p>ã€€ã€€<code>socket</code> æ˜¯ skynet ä¸­ä¸ºå•ä¸ªè¿æ¥å®šä¹‰çš„ç»“æ„ä½“ï¼Œå®ƒå…¨éƒ¨åœ¨ä¸Šé¢æåˆ°çš„ <code>slot</code> æ•°ç»„ä¸­ï¼Œä¸­é€”ä¸ä¼šåˆ›å»ºï¼Œä¼šä¸€ç›´å¤ç”¨å·²ç»åˆ›å»ºå¥½çš„å¯¹è±¡ã€‚æ¥çœ‹ä¸‹å®ƒçš„ç»“æ„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">socket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uintptr_t</span> <span class="n">opaque</span><span class="p">;</span> <span class="c1">// æœ¬ç»“æ„å…³è”çš„æœåŠ¡ handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">wb_list</span> <span class="n">high</span><span class="p">;</span> <span class="c1">// é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">wb_list</span> <span class="n">low</span><span class="p">;</span> <span class="c1">// ä½ä¼˜å…ˆçº§é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">wb_size</span><span class="p">;</span> <span class="c1">// ç­‰å¾…å†™å…¥çš„å­—èŠ‚é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">socket_stat</span> <span class="n">stat</span><span class="p">;</span> <span class="c1">// è¿æ¥çŠ¶æ€æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ATOM_ULONG</span> <span class="n">sending</span><span class="p">;</span> <span class="c1">// æ˜¯å¦æ­£åœ¨å‘é€æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œä¼šç´¯åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="c1">// å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span> <span class="c1">// åˆ†é…çš„ id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ATOM_INT</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// å½“å‰è¿æ¥çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">protocol</span><span class="p">;</span> <span class="c1">// è¿æ¥åè®®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">reading</span><span class="p">;</span> <span class="c1">// fd çš„ read ç›‘å¬æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">writing</span><span class="p">;</span> <span class="c1">// fd çš„ write ç›‘å¬æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">closing</span><span class="p">;</span> <span class="c1">// fd çš„ close æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ATOM_INT</span> <span class="n">udpconnecting</span><span class="p">;</span> <span class="c1">// udp æ­£åœ¨è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">warn_size</span><span class="p">;</span> <span class="c1">// æŠ¥è­¦é˜ˆå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// tcp è¿æ¥ç”¨ size è¡¨ç¤ºæ¯æ¬¡è¯»å–çš„å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint8_t</span> <span class="n">udp_address</span><span class="p">[</span><span class="n">UDP_ADDRESS_SIZE</span><span class="p">];</span> <span class="c1">// udp ç”¨ udp_address è¡¨ç¤ºåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">spinlock</span> <span class="n">dw_lock</span><span class="p">;</span> <span class="c1">// è‡ªæ—‹é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">dw_offset</span><span class="p">;</span> <span class="c1">// å·²ç»å†™å…¥çš„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dw_buffer</span><span class="p">;</span> <span class="c1">// dw å¾…å‘é€çš„æ•°æ®ç¼“å­˜ï¼Œä¼˜å…ˆçº§å¾ˆé«˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">size_t</span> <span class="n">dw_size</span><span class="p">;</span> <span class="c1">// dw å†™å‡ºçš„æ€»å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€socket è¿æ¥æ˜¯ä¸ªå¾ˆå¤æ‚çš„ç»“æ„ï¼Œè€Œä¸”å› ä¸ºè¦ç…§é¡¾å†…å­˜å¯¹é½çš„åŸå› ï¼Œå˜é‡å®šä¹‰çš„å…ˆåé¡ºåºæ’åˆ—å¹¶ä¸æ˜¯æŒ‰ç…§å…³è”æ€§åˆ†å¸ƒçš„ã€‚å˜é‡çš„å¤§æ¦‚ä½œç”¨å·²ç»åœ¨æ³¨é‡Šä¸­å†™å‡ºæ¥äº†ï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆä¸æ€¥è§£é‡Šå…¶ä¸­çš„ç”¨æ³•ï¼Œåé¢ä¼šé€æ­¥çœ‹åˆ°è¿™äº›å˜é‡çš„ç”¨æ³•ã€‚<br>
ã€€ã€€ç›®å‰éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œæ¯ä¸ª <code>socket</code> ç»“æ„ä½“æœ‰ä¸€ä¸ªè‡ªå·±çš„ <code>id</code>ï¼Œè¿™ä¸ª <code>id</code> å°±æ˜¯ <code>slot</code> ä¸­çš„ç´¢å¼•ï¼Œå¦å¤– <code>opaque</code> ä¿å­˜äº†æŒæœ‰è¯¥è¿æ¥çš„æœåŠ¡çš„ handleï¼Œå½“è¿æ¥ä¸Šæœ‰ç½‘ç»œæ¶ˆæ¯æ—¶ï¼Œsocket çº¿ç¨‹ä¼šç»™åˆ°è¿™ä¸ªæœåŠ¡å»å¤„ç†ã€‚å…¶å®ƒå¤§å¤šæ˜¯ä¸€äº›ç½‘ç»œçŠ¶æ€çš„å­—æ®µï¼Œåé¢ä¼šé€æ¸çœ‹åˆ°ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-id">ä¸ºä»€ä¹ˆéœ€è¦ id</h3>
<p>ã€€ã€€å¯ä»¥çœ‹åˆ°åœ¨ <code>socket</code> ä¸­é™¤äº† <code>fd</code> è¿˜æœ‰ä¸€ä¸ª <code>id</code>ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>fd</code> ä½œä¸º<code>socket</code> çš„å”¯ä¸€æ ‡è¯†å‘¢ï¼Ÿåªä» <code>fd</code> çš„åˆ†é…èŒƒå›´ä¸Šæ¥çœ‹çš„è¯ï¼Œæ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ï¼Œä½†æ˜¯å› ä¸º <code>fd</code> çš„åˆ†é…ç­–ç•¥ï¼Œå†…æ ¸å¯èƒ½ä¼šå¤ç”¨ <code>fd</code>ï¼Œè¿™å°±å¯¼è‡´äº†å†²çªå‘ç”Ÿçš„å¯èƒ½æ€§ï¼Œskynet åˆ†é…çš„ <code>id</code> ä¼šä¸æ–­ç´¯åŠ ï¼Œåœ¨éæç«¯æƒ…å†µä¸‹éƒ½ä¸ä¼šæœ‰é‡å¤çš„é£é™©ï¼Œä½œä¸º <code>socket</code> çš„å”¯ä¸€æ ‡è¯†æ˜¯æ›´åŠ åˆé€‚çš„ã€‚<br>
ã€€ã€€skynet åœ¨åˆ†é… socket çš„ ID æ—¶ï¼Œä¹Ÿä¼šç¢°åˆ°ç©ºæ´ä½ç½®çš„é—®é¢˜ï¼Œå› ä¸ºå…³é—­çš„ socket è¿æ¥ä¼šè¢«å†æ¬¡è®¾ä¸ºå¯ç”¨çŠ¶æ€ï¼Œè¿™å°±å¯¼è‡´äº†åˆ†é… ID ä¸èƒ½ç®€å•ç´¯åŠ ï¼Œè€Œæ˜¯ä» alloc_id å¼€å§‹ï¼Œéå†å®Œæ•´ä¸ª slot æ•°ç»„ï¼Œè®¡ç®—å“ˆå¸Œçš„æ—¶å€™ç›´æ¥é’ˆå¯¹ MAX_SOCKET å–æ¨¡å³å¯ã€‚è¿™é‡Œæœ‰ä¸ªå°é—®é¢˜ï¼Œalloc_id æ˜¯ä¸ªåŸå­å˜é‡ï¼Œå¯èƒ½ä¼šè®©è¿™ä¸ªåˆ†é… ID çš„å‡½æ•°çš„æ•ˆç‡é›ªä¸ŠåŠ éœœï¼Œæœ€åæƒ…å†µä¸‹åœ¨åˆ†é…ä¸€æ¬¡ ID çš„è¿‡ç¨‹ä¸­ï¼Œalloc_id è¦è¢« atomic_fetch_add ç´¯åŠ å‡ ä¸‡æ¬¡ã€‚</p>
<h2 id="socket-çº¿ç¨‹">socket çº¿ç¨‹</h2>
<h3 id="thread_socket">thread_socket</h3>
<p>ã€€ã€€socket çº¿ç¨‹å¯åŠ¨çš„ä¸»å‡½æ•°ä¸º <code>thread_socket</code>ï¼Œä¸‹é¢æ˜¯å®ƒçš„ä»£ç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">thread_socket</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">monitor</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">skynet_initthread</span><span class="p">(</span><span class="n">THREAD_SOCKET</span><span class="p">);</span> <span class="c1">// è®¾ç½®çº¿ç¨‹ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">skynet_socket_poll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> <span class="c1">// é€€å‡ºç½‘ç»œè½®è¯¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CHECK_ABORT</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span> <span class="c1">// ä¸€èˆ¬æ˜¯è¿˜æœ‰æ¶ˆæ¯æ²¡å¤„ç†å®Œï¼Œç›´æ¥ç»§ç»­å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wakeup</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// åªæœ‰å½“å…¨éƒ¨ worker çº¿ç¨‹éƒ½ç¡çœ çš„æ—¶å€™æ‰ä¼šå”¤é†’ä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€è¿™ä¸ªå‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œä¸æ–­è°ƒç”¨ <code>skynet_socket_poll</code>ï¼Œæ ¹æ®å®ƒçš„è¿”å›å€¼æ¥è¿›è¡Œæ“ä½œï¼Œå½“è¿”å›å€¼å¤§äº 0 æ—¶ï¼Œä¼šè°ƒç”¨ <code>wakeup</code> å°è¯•å”¤é†’ worker çº¿ç¨‹æ¥å¤„ç†å·¥ä½œã€‚</p>
<h3 id="skynet_socket_poll">skynet_socket_poll</h3>
<p>ã€€ã€€å‡½æ•° <code>skynet_socket_poll</code> ä¹Ÿå°±æ˜¯ socket çº¿ç¨‹çš„ä¸»å¾ªç¯äº†ï¼Œä¸‹é¢æ¥çœ‹ä¸€çœ‹å®ƒçš„å†…å®¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">skynet_socket_poll</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket_server</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">SOCKET_SERVER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket_message</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// è¿˜æœ‰å‰©ä½™äº‹ä»¶æ²¡å¤„ç†å®Œçš„æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="nf">socket_server_poll</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">more</span><span class="p">);</span> <span class="c1">// å¤„ç† epoll äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_EXIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_DATA</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_CLOSE</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_OPEN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_CONNECT</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_ERR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_ERROR</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_ACCEPT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_ACCEPT</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_UDP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_UDP</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SOCKET_WARNING</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">forward_message</span><span class="p">(</span><span class="n">SKYNET_SOCKET_TYPE_WARNING</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">skynet_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Unknown socket message type %d.&#34;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€<code>skynet_socket_poll</code> è™½ç„¶æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯è°ƒç”¨ <code>socket_server_poll</code> æ¥è·å–ä¸€ä¸ªè§¦å‘çš„ epoll äº‹ä»¶å’Œäº‹ä»¶çš„æ•°æ®ç»“æœ <code>result</code>ï¼Œç„¶åæ ¹æ®äº‹ä»¶çš„ç±»å‹ï¼Œèµ°ä¸åŒçš„ caseï¼Œè°ƒç”¨ <code>forward_message</code> å‘é€æ¶ˆæ¯ã€‚</p>
<h3 id="forward_message">forward_message</h3>
<p>ã€€ã€€åœ¨å‡½æ•° <code>forward_message</code> ä¸­ï¼Œåšçš„äº‹æƒ…å°±æ˜¯å°† <code>result</code> å‚æ•°é‡Œçš„æ•°æ®æ‰“åŒ…æˆä¸€æ¡æœåŠ¡é—´çš„æ¶ˆæ¯ <code>skynet_message</code>ï¼Œç„¶åå‘é€ç»™ä¸æœ¬å¥—æ¥å­—ç»‘å®šçš„æœåŠ¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">forward_message</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">padding</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_message</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">skynet_socket_message</span> <span class="o">*</span><span class="n">sm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ¶ˆæ¯é•¿åº¦é™åˆ¶ä¸èƒ½è¶…è¿‡ 128
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">size_t</span> <span class="n">msg_sz</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">msg_sz</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">msg_sz</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">sz</span> <span class="o">+=</span> <span class="n">msg_sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">sm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">skynet_socket_message</span> <span class="o">*</span><span class="p">)</span> <span class="nf">skynet_malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sm</span><span class="o">-&gt;</span><span class="n">ud</span> <span class="o">=</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sm</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠ data çš„æ•°æ®è¿½åˆ° sm çš„æœ€åé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">memcpy</span><span class="p">(</span><span class="n">sm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sm</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sm</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ„é€ ä¸€æ¡æ–°çš„ skynet æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">skynet_message</span> <span class="n">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span><span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">|</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">PTYPE_SOCKET</span> <span class="o">&lt;&lt;</span> <span class="n">MESSAGE_TYPE_SHIFT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">skynet_context_push</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// å‘å‡ºæ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// todo: report somewhere to close socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// don&#39;t call skynet_socket_close here (It will block mainloop)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">skynet_free</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">skynet_free</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€<code>socket_message</code> ä¸­çš„ <code>opaque</code> å­—æ®µä¸ <code>socket</code> ä¸­çš„æ„æ€ä¸€æ ·ï¼Œéƒ½æ˜¯ç›®æ ‡æœåŠ¡çš„ handleï¼Œæ„é€ å¥½æ¶ˆæ¯ä»¥åï¼Œè°ƒç”¨äº† <code>skynet_context_push</code> å°†æ¶ˆæ¯å‘é€ç»™äº†ç›®æ ‡æœåŠ¡ã€‚</p>
<h3 id="socket_server_poll">socket_server_poll</h3>
<p>ã€€ã€€å‡½æ•° <code>socket_server_poll</code> æ˜¯ skynet ç½‘ç»œéƒ¨åˆ†å¤„ç†ç½‘ç»œäº‹ä»¶çš„æœ€ç»ˆå¾ªç¯ã€‚è¯¥å‡½æ•°ä¼šé˜»å¡åœ¨ <code>epoll_wait</code> ä¸Šï¼Œå½“ä» epoll_wait ä¸­å”¤é†’ä»¥åï¼Œå¼€å§‹ä¸€è½®äº‹ä»¶çš„å¤„ç†ã€‚é‰´äºè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé•¿çš„å‡½æ•°ï¼Œç›´æ¥è´´å…¨éƒ¨æºç æ¥æœ‰ç‚¹å“äººï¼Œæ‰€ä»¥æˆ‘ä¼šæ‹†å¼€æ¥åˆ†æè¿™ä¸ªå‡½æ•°ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸ªå…¨è²Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">socket_server_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket_server</span> <span class="o">*</span><span class="n">ss</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_message</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. å¤„ç†ç½‘ç»œå‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2. å¤„ç†ä¸€è½®äº‹ä»¶å®Œæ¯•ä»¥åçš„æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 3. å¤„ç†å•ä¸ªäº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€è¦äº‹å…ˆè¯´æ˜çš„æ˜¯ <code>socket_server_poll</code> å¹¶ä¸æ˜¯ä¸€æ¬¡å¤„ç†å…¨éƒ¨äº‹ä»¶çš„ï¼Œå®ƒä¼šå°†è§¦å‘çš„äº‹ä»¶ä¿å­˜ä¸‹æ¥ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªäº‹ä»¶ï¼Œå°†æ‰§è¡Œç»“æœç›´æ¥è¿”å›ç»™æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ <code>skynet_socket_poll</code>ï¼Œç”±å®ƒæ ¹æ®ä¸åŒçš„è¿”å›å€¼æ¥è¿›è¡Œä¸åŒçš„æ¶ˆæ¯è½¬å‘ã€‚æ‰€ä»¥å¯ä»¥æŠŠä¸€æ¬¡ <code>epoll_wait</code> è¿”å›å¾—åˆ°çš„è§¦å‘äº‹ä»¶ç§°ä¸ºâ€œä¸€è½®äº‹ä»¶â€ï¼Œå¦‚æœæœ¬è½®äº‹ä»¶è¿˜æœªç»“æŸæ—¶ï¼Œä¸ä¼šå†æ¬¡è¿›å…¥ <code>epoll_wait</code> çš„é˜»å¡ä¸­ï¼Œè€Œæ˜¯ä¼šç»§ç»­å¤„ç†ä¹‹å‰ä¿å­˜çš„äº‹ä»¶ï¼Œç›´åˆ°ä¹‹å‰ä¿å­˜çš„äº‹ä»¶éƒ½å¤„ç†å®Œæ¯•äº†ï¼Œæ‰ä¼šå†æ¬¡é™·å…¥é˜»å¡æ‹¿å–æ–°çš„è§¦å‘äº‹ä»¶ã€‚<br>
ã€€ã€€æŒ‰é¡ºåºæˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¤„ç†ç½‘ç»œå‘½ä»¤éƒ¨åˆ†çš„æºç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">checkctrl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯»å–æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">has_cmd</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="nf">ctrl_cmd</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">clear_closed_event</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ss</span><span class="o">-&gt;</span><span class="n">checkctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ã€€ã€€è¿™ä¸€éƒ¨åˆ†é¦–å…ˆä¼šæ£€æŸ¥ <code>socket_server</code> çš„ <code>checkctrl</code> å­—æ®µæ˜¯å¦ä¸º 1ï¼Œå¦‚æœä¸º 1ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ <code>has_cmd</code> å°è¯•ä»å‘½ä»¤ç®¡é“çš„æ¥æ”¶ç«¯è¯»å–æ•°æ®ã€‚å¦‚æœæˆåŠŸè¯»åˆ°äº†å‘½ä»¤ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ <code>ctrl_cmd</code> æ¥å¤„ç†ä¸€æ¡å‘½ä»¤ï¼Œè¿”å›å€¼å¦‚æœæ˜¯ -1 ä»£è¡¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸä¸”ä¸éœ€è¦é€šçŸ¥å…³è”çš„æœåŠ¡ã€‚
ã€€ã€€åœ¨æ¯è½®çš„å¤„ç†ä¸­ï¼Œé¦–å…ˆä¼šæŠŠæ£€æŸ¥æ§åˆ¶å‘½ä»¤çš„å˜é‡ checkctrl ç½®ä¸º 1ï¼Œç„¶åå¼€å§‹ä¾æ¬¡å¤„ç†æœ¬æ¬¡è§¦å‘çš„ç½‘ç»œäº‹ä»¶ã€‚<br>
ã€€ã€€åœ¨ç½‘ç»œäº‹ä»¶çš„å¤„ç†ä¸­ï¼Œå¦‚æœç¢°åˆ°çš„æ˜¯å‘½ä»¤äº‹ä»¶ï¼Œåˆ™ç›´æ¥ continue å›åˆ°å¾ªç¯çš„æœ€ä¸Šé¢å»å¤„ç†ç½‘ç»œå‘½ä»¤ã€‚å¦åˆ™åˆ™ä¼šå»è¯»å– socket çš„çŠ¶æ€ typeï¼Œæ ¹æ®ä¸åŒçš„ type æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œå‘ result ä¸­å¡«å……ç›¸å…³çš„æ•°æ®ã€‚<br>
ã€€ã€€æ¯æ¬¡ä» epoll ä¸­å–åˆ°çš„å°±ç»ªå¥—æ¥å­—ä¸ªæ•°æ”¾åœ¨ event_n ä¸­ï¼Œç”¨ä¸€ä¸ªå˜é‡ event_index ä¿å­˜å½“å‰å¤„ç†åˆ°äº†ç¬¬å‡ ä¸ªå¥—æ¥å­—ã€‚å½“ event_index == event_n çš„æ—¶å€™ï¼Œåˆ™è¯´æ˜æœ¬è½®çš„å¤„ç†å·²ç»ç»“æŸäº†ï¼Œçº¿ç¨‹ä¼šå†æ¬¡è°ƒç”¨ epoll_wait è·å–ä¸‹ä¸€è½®è¦å¤„ç†çš„å°±ç»ªå¥—æ¥å­—ã€‚<br>
ã€€ã€€æœ¬å‡½æ•°ä¼šå¡«å…… result å‚æ•°ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¤„ç†ç»“æœç±»å‹ç»™ skynet_socket_pollï¼Œè¿”å›çš„ç»“æœä¸€å…±åŒ…å«äº†å…«ç§ç±»å‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define SOCKET_DATA 0       </span><span class="c1">// è¯»å–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_CLOSE 1      </span><span class="c1">// socket å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_OPEN 2       </span><span class="c1">// socket è¿æ¥æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_ACCEPT 3     </span><span class="c1">// accept æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_ERR 4        </span><span class="c1">// socket é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_EXIT 5       </span><span class="c1">// é€€å‡º socket çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_UDP 6        </span><span class="c1">// æ¥æ”¶ udp æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SOCKET_WARNING 7    </span><span class="c1">// socket è­¦å‘Š
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç½‘ç»œæŒ‡ä»¤å¤„ç†">ç½‘ç»œæŒ‡ä»¤å¤„ç†</h3>
<p>ã€€ã€€æ¯å½“ epoll_wait è¿”å›æ—¶ï¼Œæ–°çš„ä¸€è½®ç½‘ç»œäº‹ä»¶çš„å¤„ç†å°±ä¼šå¼€å§‹ï¼ŒæŒ‡ä»¤çš„æ£€æŸ¥æ ‡è®° checkctrl ä¹Ÿä¼šè¢«è®¾ä¸º 1ï¼Œæ¥å¼€å¯æŒ‡ä»¤æ£€æŸ¥ã€‚æ¯è½®åªä¼šå¤„ç†ä¸€æ¬¡æŒ‡ä»¤ï¼Œä¼šä¸€ç›´è¿ç»­å¤„ç†æŒ‡ä»¤ç›´åˆ°å…¨éƒ¨å¤„ç†å®Œã€‚<br>
ã€€ã€€é€šè¿‡ has_cmd æ¥æ£€æŸ¥ç®¡é“ä¸­æœ‰æ²¡æœ‰è¿˜æ²¡å¤„ç†çš„å‘½ä»¤æ•°æ®ã€‚è¿™ä¸€æ­¥æ˜¯ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ select æ¥å®ç°çš„ï¼Œä½¿ç”¨ select æ¥æ£€æŸ¥ recvctrl_fd æ˜¯å¦å¯è¯»ã€‚è™½è¯´ recvctrl_fd è¢«åŠ åˆ°äº† epoll ä¸­ï¼Œä½†æ˜¯ epoll_wait å”¤é†’ä»¥åï¼Œå¦‚æœæ˜¯æŒ‡ä»¤æ•°æ®å”¤é†’çš„ï¼Œä¸ä¼šåŸåœ°å¤„ç†ï¼Œè€Œæ˜¯ç­‰ä¸‹ä¸€ä¸ªå¾ªç¯å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜è¦å†æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦å¯è¯»ï¼Œå¹¶æ²¡æœ‰ä»¥æ¥ epoll åšæ ‡è®°ä¹‹ç±»çš„ï¼Œå¯èƒ½æ˜¯ä¸ºäº†å¤„ç†ç®€å•ä¸€äº›ã€‚<br>
ã€€ã€€å¦‚æœ recvctrl_fd ä¸­æœ‰æŒ‡ä»¤ç­‰å¾…è¯»å–ï¼Œåˆ™è°ƒç”¨ ctrl_cmd è¯»å–å¹¶æ‰§è¡ŒæŒ‡ä»¤ã€‚å…¶ä¸­ç”¨äº†ä¸¤æ¬¡ block_readpipe æ¥è¯»å–ç®¡é“ä¸­çš„æ•°æ®ï¼Œç¬¬ä¸€æ¬¡è¯»å–äº†æ•°æ®å¤´ï¼ŒåŒ…æ‹¬äº†å‘½ä»¤ç±»å‹å’Œæ•°æ®é•¿åº¦ï¼Œç¬¬äºŒæ¬¡ç”¨ç¬¬ä¸€æ¬¡è¯»å–åˆ°çš„æ•°æ®é•¿åº¦è¯»å–äº†æ•°æ®ã€‚<br>
ã€€ã€€block_readpipe æ˜¯ç”¨æ¥ä»ç®¡é“ä¸­è¯»å–æ•°æ®çš„å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹ï¼Œread çš„è¿”å›å€¼åªå¤„ç†äº†å°äº 0 çš„æƒ…å†µï¼Œå¹¶æ²¡æœ‰å¤„ç† n &gt; 0 &amp;&amp; n &lt; size çš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸ºå¯¹ç®¡é“å¥—æ¥å­—æ‰§è¡Œ read æ“ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸ä¼šè¢«åˆ«çš„æƒ…å†µæ¯”å¦‚ä¿¡å·ä¹‹ç±»çš„æ‰“æ–­ï¼Œæ‰€ä»¥åªæœ‰ä¸¤ç§å¯èƒ½ï¼Œé”™è¯¯å’Œå…¨éƒ¨è¯»å–å®Œæˆã€‚å…³äº pipe å¥—æ¥å­—çš„è¯»å†™åé¢å¯ä»¥è€ƒè™‘å¼€ä¸€ç¯‡æ–‡ç« å†™ä¸€ä¸‹ã€‚<br>
ã€€ã€€è¯»å–åˆ°äº†å‘½ä»¤ä»¥åï¼Œæ ¹æ®å‘½ä»¤ç±»å‹ï¼ŒæŠŠæ•°æ®äº¤ç»™ä¸åŒçš„å¤„ç†å‡½æ•°æ¥å¤„ç†å³å¯ã€‚</p>
<h2 id="ç½‘ç»œè¯·æ±‚">ç½‘ç»œè¯·æ±‚</h2>
<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>
<p>ã€€ã€€skynet ä¸­æ¶‰åŠç½‘ç»œçš„æ“ä½œï¼Œé™¤äº† direct write ä»¥å¤–ï¼Œéƒ½æ˜¯é€šè¿‡ç½‘ç»œè¯·æ±‚æ¥å®ç°çš„ã€‚worker çº¿ç¨‹æ ¹æ®è‡ªå·±æƒ³è¦åšçš„æ“ä½œçš„ç±»å‹ï¼Œåˆ›å»ºä¸åŒç»“æ„çš„è¯·æ±‚æ•°æ®ï¼Œé€šè¿‡ send_request å‘é€åˆ°å‘½ä»¤ç®¡é“çš„å‘é€ç«¯ sendctrl_fd ä¸­å»ï¼Œç­‰å¾…ä¸»å¾ªç¯ä¸­æ¥å—å¤„ç†è¯·æ±‚ã€‚</p>
<h3 id="è¯·æ±‚åŒ…çš„ç»“æ„">è¯·æ±‚åŒ…çš„ç»“æ„</h3>
<p>ã€€ã€€å› ä¸º C ä¸­æ²¡æœ‰é¢å‘å¯¹è±¡çš„åŠŸèƒ½ï¼Œæ‰€ä»¥é€šè¿‡ union æ¥å®ç°äº†è¯·æ±‚åŒ…çš„ç»“æ„ï¼Œæ¯ä¸€ç§ç±»å‹çš„è¯·æ±‚å¯¹åº”äº†ä¸€ç±»çš„è¯·æ±‚ç»“æ„ä½“ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè½¬åŒ–æˆä¸€ä¸ª request_package ç»“æ„ä½“ï¼Œå‘é€åˆ°ç®¡é“ä¸­æ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">request_package</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">// 6 bytes dummy, ç¬¬ 7 ä¸ªå­—èŠ‚è¡¨ç¤ºç±»å‹ï¼Œç¬¬ 8 ä¸ªå­—èŠ‚è¡¨ç¤ºé•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_open</span> <span class="n">open</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_send</span> <span class="n">send</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_send_udp</span> <span class="n">send_udp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_close</span> <span class="n">close</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_listen</span> <span class="n">listen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_bind</span> <span class="n">bind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_resumepause</span> <span class="n">resumepause</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_setopt</span> <span class="n">setopt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_udp</span> <span class="n">udp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">request_setudp</span> <span class="n">set_udp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">dummy</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// é¢„ç•™äº† 256 ä¸ªå­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¤„ç†è¯·æ±‚åŒ…">å¤„ç†è¯·æ±‚åŒ…</h3>
<p>ã€€ã€€socket çº¿ç¨‹çš„ä¸»å¾ªç¯ä¸­ï¼Œä¼šä¸æ–­è¯»å–ç®¡é“ä¸­çš„æ•°æ®ï¼Œæ¯æ¡å‘½ä»¤è¦æ‰§è¡Œä¸¤æ¬¡ read è¯»å–ï¼Œç¬¬ä¸€æ¬¡è¦è¯»åˆ° header ä¸­çš„å†…å®¹ï¼Œç„¶åæ ¹æ® header[1] çš„é•¿åº¦æ•°æ®ï¼Œè¯»å–å‰©ä½™çš„æ•°æ®ã€‚ç„¶åæ ¹æ® hander[0] ä¸­çš„ç±»å‹æ•°æ®ï¼Œè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚ç›®å‰ä¸€å…±æœ‰ 13 ç§ç½‘ç»œæ“ä½œç±»å‹ã€‚</p>
<blockquote>
<p>S Start socket<br>
B Bind socket<br>
L Listen socket<br>
K Close socket<br>
O Connect to (Open)<br>
X Exit<br>
D Send package (high)<br>
P Send package (low)<br>
A Send UDP package<br>
T Set opt<br>
U Create UDP socket<br>
C set udp address<br>
Q query info</p>
</blockquote>
<h2 id="ç½‘ç»œæ¥å£åˆ†æ">ç½‘ç»œæ¥å£åˆ†æ</h2>
<h3 id="æ¦‚è¿°-1">æ¦‚è¿°</h3>
<p>ã€€ã€€å› ä¸ºæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½æ˜¯é€šè¿‡å‘é€å‘½ä»¤æ¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥ skynet çš„ç½‘ç»œæ¥å£éƒ½æ˜¯éé˜»å¡çš„ï¼Œä¸åŒçš„æ¥å£ä¼šå®ŒæˆåŸºæœ¬çš„æ“ä½œï¼Œç„¶åæŠŠéœ€è¦çš„å‚æ•°æ‰“åŒ…æˆä¸€æ¡ä¸Šé¢æåˆ°è¿‡çš„ request_package ç»“æ„æ•°æ®å‘é€ç»™å‘½ä»¤çš„æ¥æ”¶ç«¯ã€‚</p>
<h3 id="connect">connect</h3>
<p>ã€€ã€€é€šè¿‡è°ƒç”¨ socketdriver.connect å¯ä»¥å‘èµ·ä¸€ä¸ªå¯¹å¤–è¿æ¥ã€‚lconnect ä¸­ä¼šä»ç›®æ ‡åœ°å€çš„å­—ç¬¦ä¸²ä¸­åˆ†ç¦»å‡º host å’Œ port è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå†è·å–ä¸€ä¸ª socket idï¼Œç„¶åæ‰“åŒ…æˆä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œç»™å‘½ä»¤æ¥æ”¶å¥—æ¥å­—å‘é€äº†ä¸€ä¸ª &lsquo;O&rsquo; ç±»å‹çš„å‘½ä»¤ã€‚<br>
ã€€ã€€åœ¨ socekt çº¿ç¨‹ä¸­çš„éƒ¨åˆ†é‡Œï¼Œå¯¹åº”å‘½ä»¤çš„å¤„ç†æ–¹æ³•æ˜¯ open_socketï¼Œé¦–å…ˆå®ƒä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨ getaddrinfo æ‹¿åˆ°ç›®æ ‡ä¸»æœºçš„å…¨éƒ¨åœ°å€ï¼Œç„¶åä¾æ­¤å¯¹æ¯ä¸ªåœ°å€å°è¯•å»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ socket åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—å¹¶ä¸”æŠŠå®ƒè®¾ä¸º keep_alive å’Œ non_blocking çš„ï¼Œç„¶åæ‰§è¡Œ connect ç³»ç»Ÿè°ƒç”¨ã€‚<br>
ã€€ã€€å¦‚æœå¥—æ¥å­—åˆ›å»ºæˆåŠŸäº†ï¼Œåˆ™åˆ›å»º socket ç»“æ„ä½“ã€‚æ£€æŸ¥ connect çš„è°ƒç”¨è¿”å›ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œåˆ™ç›´æ¥æŠŠ socket çš„çŠ¶æ€è®¾ä¸º SOCKET_TYPE_CONNECTEDï¼Œè¿”å› SOCKET_OPENï¼Œè¿æ¥æˆåŠŸã€‚<br>
ã€€ã€€å¦‚æœè¿æ¥å¤±è´¥äº†ï¼Œä¸” errno æ˜¯ EINPROGRESSï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•é©¬ä¸Šè¿æ¥çš„çŠ¶æ€ï¼Œåˆ™æŠŠ socket çš„çŠ¶æ€è®¾ä¸º SOCKET_TYPE_CONNECTINGï¼Œå¹¶ä¸”å°†å¥—æ¥å­—åŠ å…¥åˆ° epoll ä¸­ï¼Œæ‰“å¼€å†™å…¥äº‹ä»¶ã€‚å½“ epoll è§¦å‘äº†å¥—æ¥å­—çš„ write äº‹ä»¶æ—¶ï¼Œåˆ™è¯´æ˜ä¹‹å‰çš„è¿æ¥å·²ç»å»ºç«‹æˆåŠŸäº†ã€‚å°† socket çš„çŠ¶æ€è®¾ä¸º SOCKET_TYPE_CONNECTEDï¼Œè¿”å› SOCKET_OPEN è¡¨ç¤ºè¿æ¥æˆåŠŸã€‚<br>
ã€€ã€€SOCKET_OPEN è¿”å›ä»¥åï¼Œä¼šåˆ›å»ºä¸€ä¸ª SKYNET_SOCKET_TYPE_CONNECT ç±»å‹çš„æ¶ˆæ¯ç»™å‘èµ·è¿æ¥çš„æºæœåŠ¡ï¼Œä½†æ˜¯æºæœåŠ¡å¹¶ä¸éœ€è¦å¤„ç†è¿æ¥æˆåŠŸçš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ netpack åœ¨è¿›è¡Œè§£åŒ…çš„æ—¶å€™ï¼Œç›´æ¥å¿½ç•¥äº† SKYNET_SOCKET_TYPE_CONNECT ç±»å‹çš„æ¶ˆæ¯ã€‚</p>
<h3 id="listen">listen</h3>
<p>ã€€ã€€ä» gateserver çš„ open å‘½ä»¤æ¥åˆ†æä¸€ä¸‹ skynet å¥—æ¥å­—çš„ç›‘å¬æ­¥éª¤ã€‚socketdriver.listen æ˜¯ skynet çš„ç›‘å¬æ¥å£ï¼Œå¯ä»¥å¼€å¯ä¸€ä¸ªç›‘å¬å¥—æ¥å­—ï¼Œå‡½æ•°è¿”å›å€¼æ˜¯ç›‘å¬å¥—æ¥å­—çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„ id è¿™ä¸ªå˜é‡ã€‚ç›‘å¬çš„æ¥å£æ‰§è¡Œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªæ˜¯åœ¨ worker çº¿ç¨‹ä¸­æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨ socket çº¿ç¨‹ä¸­æ‰§è¡Œçš„éƒ¨åˆ†ã€‚<br>
ã€€ã€€ç›‘å¬æ“ä½œåœ¨ç¬¬ä¸€é˜¶æ®µçš„æ‰§è¡Œä¸­ï¼Œä¸»è¦é€»è¾‘åœ¨ socket_server_listen å‡½æ•°ä¸­ï¼Œå…¶ä¸­ä¾æ¬¡è°ƒç”¨äº† socket/bind/listen ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œå®Œæˆäº†ç½‘ç»œå¥—æ¥å­—çš„åˆ›å»ºï¼Œç»‘å®šå’Œç›‘å¬ï¼Œä½†æ˜¯å¹¶æœªå°†å¥—æ¥å­—åŠ å…¥åˆ° epoll çš„ç®¡ç†ä¸­å»ã€‚ç„¶åé€šè¿‡ reserve_id åˆ†é…äº†ä¸€ä¸ª socket ç»“æ„çš„å”¯ä¸€ idï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿä¸ä¼šåˆ›å»º socket ç»“æ„ä½“ã€‚åˆ›å»ºä¸€ä¸ª request_package çš„ç»“æ„ä½“ï¼Œå°†ä¸Šé¢æ‹¿åˆ°çš„å‚æ•°å¡«å…¥å…¶ request_listen ç»“æ„ä½“ä¸­ï¼Œç„¶åå°†å…¶å‘é€ç»™å‘½ä»¤çš„æ¥æ”¶å¥—æ¥å­— sendctrl_fd å³å¯ã€‚<br>
ã€€ã€€ç›‘å¬æ“ä½œåœ¨ç¬¬äºŒé˜¶æ®µçš„æ‰§è¡Œä¸­ï¼Œä¸»è¦é€»è¾‘åœ¨ listen_socket å‡½æ•°ä¸­ã€‚è¿™é‡Œé€»è¾‘å°±æ¯”è¾ƒç®€å•äº†ï¼Œåšçš„äº‹æƒ…å°±æ˜¯ä¸Šæ®µä¸­ç‚¹æ˜äº†å‰©ä¸‹çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒæŠŠç›‘å¬å¥—æ¥å­—åŠ å…¥åˆ° epoll ç®¡ç†ä¸­ï¼Œå¹¶ä¸”åˆ›å»ºäº† socket ç»“æ„å˜é‡ã€‚socket ä¸­çš„ type ä¼šè¢«ä¿®æ”¹ä¸º SOCKET_TYPE_PLISTENï¼Œåªæ˜¯ pre listen è¿˜æ²¡æœ‰å®Œå…¨å®Œæˆç›‘å¬ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸Šä¸€é˜¶æ®µå·²ç»æ‹¿åˆ°äº† socket çš„å”¯ä¸€ idï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ç›´æ¥ä¿®æ”¹äº†ä¹‹å‰é‚£ä¸ª id åœ¨æ•°ç»„ socket_server.slot ä¸­å¯¹åº”çš„ socket ç»“æ„ä½“ã€‚<br>
ã€€ã€€åˆ°è¿™é‡Œ socketdriver.listen çš„å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œä½†æ˜¯æ˜æ˜¾å¯ä»¥å‘ç°è¿™ä¸ªæ—¶å€™çš„ listen è¿˜æœªå®Œå…¨å®Œæˆã€‚å› ä¸ºæ­¤æ—¶è¿˜æœªè®¾ç½® accept ä»¥åçš„å›è°ƒï¼Œè€Œä¸” socket ä¸­çš„çŠ¶æ€ä¹Ÿè¿˜æ˜¯æœªå®Œæˆçš„ç›‘å¬çŠ¶æ€ã€‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª socket id æ˜¯ç›‘å¬å¥—æ¥å­—çš„å¥æŸ„ï¼Œéœ€è¦åšçš„æ˜¯ä½¿ç”¨è¿™ä¸ª id è°ƒç”¨ socketdriver.start æ¥æ‰§è¡Œåç»­çš„æ­¥éª¤ã€‚<br>
ã€€ã€€socketdriver.start ä¸­ä¸»è¦åšçš„äº‹æƒ…æ˜¯ç»™ç½‘ç»œå‘½ä»¤æ¥æ”¶å¥—æ¥å­—å‘é€äº†ä¸€ä¸ª &lsquo;R&rsquo; è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šæŠŠ id å¯¹åº”çš„å¥—æ¥å­—åŠ å…¥åˆ° epoll ç®¡ç†ä¸­å¹¶ä¸”æ‰“å¼€è¯»å–ç›‘å¬ã€‚ä¸è¿‡ç”±äº listen çš„å‰æœŸåˆ›å»º socket çš„æ—¶å€™å·²ç»æŠŠå¥—æ¥å­—åŠ å…¥åˆ°äº† epoll å¹¶ä¸”é»˜è®¤æ˜¯æ‰“å¼€è¯»å–çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸ä¼šåšä»€ä¹ˆæ“ä½œã€‚è¿™é‡Œæœ€ä¸»è¦ä¿®æ”¹çš„æ˜¯ä¸Šé¢æåˆ°çš„ socket çš„çŠ¶æ€ï¼Œä¼šæŠŠçŠ¶æ€æ”¹ä¸º SOCKET_TYPE_LISTENï¼Œä»¥è®©å¾ªç¯ä¸­å¯ä»¥æ­£ç¡®å¤„ç†ç›‘å¬ï¼Œç„¶åè¿˜æŠŠç›‘å¬ socket çš„æºæœåŠ¡æ”¹ä¸ºäº†è°ƒç”¨ start çš„æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥å®ç°åœ¨æŸä¸ªæœåŠ¡ä¸­ listen åˆ›å»ºä¸€ä¸ª socket idï¼Œç„¶åæŠŠå®ƒä¼ ç»™å¦ä¸€ä¸ªæœåŠ¡ï¼Œç”±å¦ä¸€ä¸ªæœåŠ¡è°ƒç”¨ start æ¥æ¥æ”¶åç»­çš„æ¶ˆæ¯ã€‚</p>
<h3 id="accept">accept</h3>
<p>ã€€ã€€accept ç”± socket çº¿ç¨‹çš„ epoll å¾ªç¯è§¦å‘ï¼Œå¦‚æœè§¦å‘ç½‘ç»œäº‹ä»¶çš„å¥—æ¥å­—æ˜¯ SOCKET_TYPE_LISTEN çŠ¶æ€çš„è¯ï¼Œåˆ™è¯´æ˜è§¦å‘äº† accept äº‹ä»¶ã€‚<br>
ã€€ã€€report_accept æ˜¯å¤„ç† accept äº‹ä»¶çš„å‡½æ•°ï¼Œé¦–å…ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨ accept æ‹¿åˆ°ç½‘ç»œå¥—æ¥å­—ï¼Œç„¶åæ‹¿åˆ° socket ç»“æ„è¦ç”¨çš„å”¯ä¸€ idï¼Œclient çš„ fd ä¼šè¢«è®¾ç½® keep_live å’Œ no_blockingï¼Œåˆ›å»º socket
ç»“æ„ï¼ŒæŠŠ socket çš„çŠ¶æ€è®¾ä¸º SOCKET_TYPE_PACCEPT ç±»å‹ã€‚<br>
ã€€ã€€ä¸Šè¿°å¤„ç†ç»“æŸä»¥åï¼Œè¿”å›åˆ° skynet_socket_poll çš„ç±»å‹ä¸º SOCKET_ACCEPTï¼Œskynet_socket_poll ä¼šè°ƒç”¨ forward_message ç»™ socket çš„æºæœåŠ¡å‘æ¶ˆæ¯ï¼Œsocket çš„æºæœåŠ¡ç°åœ¨æ˜¯ä¸Šä¸€æ­¥ä¸­æ‰§è¡Œ socketdriver.start çš„æœåŠ¡ã€‚å‘é€çš„æ¶ˆæ¯ä¸­æŠŠæ¶ˆæ¯ç»“æ„ä½“ä¸­çš„ type è®¾ä¸ºäº† SKYNET_SOCKET_TYPE_ACCEPT æ¥æ ‡è¯†æ¶ˆæ¯çš„ç±»å‹ã€‚<br>
ã€€ã€€æ¶ˆæ¯ä¼šäº¤ç»™ gate æœåŠ¡å¤„ç†ï¼Œå®ƒæ³¨å†Œäº† &ldquo;socket&rdquo; ç±»å‹çš„åè®®ï¼Œè´Ÿè´£è§£åŒ…çš„æ˜¯ netpack.filter å‡½æ•°ã€‚lfilter åœ¨å¤„ç† SKYNET_SOCKET_TYPE_ACCEPT æ—¶å¾ˆç®€å•ï¼Œåªæ˜¯æ•´ç†äº†ä¸€ä¸‹å‚æ•°è€Œå·²ï¼Œå‹å…¥äº†æ“ä½œç±»å‹å¯¹åº”çš„å­—ç¬¦ä¸² &ldquo;open&rdquo; ä¾› dispatch æ–¹æ³•è°ƒç”¨ã€‚<br>
ã€€ã€€åœ¨ dispatch ä¸­ï¼Œ&ldquo;open&rdquo; æ“ä½œå¯¹åº”äº† MSG.open æ–¹æ³•ï¼Œå…¶ä¸­è·Ÿç½‘ç»œå±‚æœ‰å…³çš„å°±æ˜¯è°ƒç”¨äº† handle.connectï¼Œåœ¨ handle.connect ä¸­ï¼Œå†ç»åƒéš¾ä¸‡è‹¦ï¼Œå¦‚æœæ˜¯ç”¨ examples ä¸­æä¾›çš„ç¤ºä¾‹çš„è¯ï¼Œå°±æ˜¯ç»è¿‡äº† watchdog å’Œ agent çš„æ“ä½œï¼Œæœ€ç»ˆè°ƒç”¨äº† socketdriver.start æ¥æ¿€æ´»å®¢æˆ·ç«¯çš„ socket ç»“æ„ã€‚ä¸ listen çš„æ­¥éª¤ç±»ä¼¼ï¼Œåœ¨ start ä¸­ä¼šæŠŠ client çš„ socket ç±»å‹ä» SOCKET_TYPE_PACCEPT æ”¹ä¸º SOCKET_TYPE_CONNECTEDï¼Œsocket å…³è”çš„æœåŠ¡ handle ä¼šæ”¹ä¸ºè°ƒç”¨ socketdriver.start çš„æœåŠ¡ã€‚</p>
<h3 id="write">write</h3>
<p>ã€€ã€€å‘é€æ•°æ®æœ‰ä¸¤ç§æ–¹æ³•ï¼Œå¸¸è§„çš„æ˜¯é€šè¿‡ epoll çš„å†™äº‹ä»¶è§¦å‘ã€‚ä¸ºäº†å‡å°‘ä¸€äº›å¼€é”€ï¼Œskynet è¿˜åšäº†ä¸€ä¸ªå«åš direct write çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å†™å…¥ï¼Œä¸é€šè¿‡ socket çº¿ç¨‹ï¼Œè€Œæ˜¯åœ¨ worker çº¿ç¨‹ç›´æ¥å°è¯•æŠŠæ•°æ®å‘å‡ºå»ã€‚<br>
ã€€ã€€é¦–å…ˆæ¥çœ‹ direct write çš„éƒ¨åˆ†ï¼Œå‘é€æ•°æ®çš„æ¥å£ä¸º socket_server_sendï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆä¼šæ£€æŸ¥å½“å‰ socket èƒ½ä¸èƒ½ç›´æ¥å‘é€ï¼Œå¦‚æœåœ¨å½“å‰ socket çš„é«˜æˆ–ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ç­‰å¾…å‘é€çš„ï¼Œåˆ™ä¸èƒ½ç›´æ¥å‘é€ã€‚å¦‚æœå¯ä»¥ç›´æ¥å‘é€çš„è¯ï¼Œåˆ™ä¼šç›´æ¥åœ¨ worker çº¿ç¨‹è°ƒç”¨ write å¾€å¥—æ¥å­—ä¸­å†™å…¥æ•°æ®ã€‚<br>
ã€€ã€€ç›´æ¥å‘é€ä¼šæœ‰ä¸‰ç§ç»“æœã€‚å¦‚æœå‘é€å¤±è´¥äº†ï¼Œåˆ™å¿½ç•¥è¿™ä¸ªé”™è¯¯ï¼Œå½“ä½œå†™å…¥äº† 0 é•¿åº¦çš„æ•°æ®ã€‚å¦‚æœå®Œæ•´å‘é€äº†å…¨éƒ¨çš„æ•°æ®ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å†èµ°åé¢çš„æ­¥éª¤äº†ï¼Œæœ¬æ¬¡å‘é€å·²ç»å®Œæˆäº†ã€‚å¦‚æœåªå‘é€äº†éƒ¨åˆ†æ•°æ®ï¼ŒåŒ…æ‹¬å‰é¢å‘é€é”™è¯¯äº§ç”Ÿçš„ç»“æœï¼Œéƒ½ä¼šè®¾ç½® dw_buffer/dw_size/dw_offset è¿™ä¸‰ä¸ªå˜é‡ï¼Œç­‰å¾…åç»­ socket çº¿ç¨‹å†æ¬¡è¿›è¡Œæ•°æ®å‘é€ï¼Œå¹¶ä¸”å‘é€äº†ä¸€æ¡ç½‘ç»œæ¶ˆæ¯ &lsquo;W&rsquo; æ¥æ‰“å¼€æœ¬å¥—æ¥å­—çš„å†™äº‹ä»¶ç›‘å¬ã€‚<br>
ã€€ã€€è§¦å‘ epoll çš„å†™äº‹ä»¶ä»¥åï¼Œå¦‚æœæœ‰ä¹‹å‰ direct write é˜¶æ®µæ²¡å‘å®Œçš„æ•°æ®ï¼Œä¼šé¦–å…ˆæŠŠå‰©ä½™çš„æ•°æ®åŠ å…¥åˆ°é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é¦–éƒ¨ã€‚å‘é€é˜¶æ®µï¼Œä¼šä¼˜å…ˆå…ˆå‘é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—çš„æ•°æ®ï¼Œç„¶åå†å‘ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œå¦‚æœä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„æ•°æ®æ²¡æœ‰å…¨éƒ¨å‘å®Œï¼Œåˆ™ä¼šå€ŸåŠ©ä¸€ä¸ªå«åš raise_uncomplete çš„æ“ä½œï¼ŒæŠŠå‰©ä½™çš„æ•°æ®æåˆ°é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ã€‚<br>
ã€€ã€€åœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šè§¦å‘å…³é—­å¥—æ¥å­—å†™äº‹ä»¶çš„ç›‘å¬ï¼Œé¦–å…ˆæ˜¯å¦‚æœ write å¦‚æœè¿”å›äº†ä¸€ä¸ªé”™è¯¯ï¼Œä¸”ä¸æ˜¯ EINTRï¼ˆä¿¡å·æ‰“æ–­ï¼‰ æˆ–è€… EAGAINï¼ˆéé˜»å¡å¥—æ¥å­—ç¼“å†²åŒºå†™æ»¡ï¼‰ é”™è¯¯çš„æƒ…å†µä¸‹ä¼šå…³é—­å†™äº‹ä»¶ã€‚è¿˜æœ‰å°±æ˜¯å½“å¥—æ¥å­—çš„é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œä½ä¼˜å…ˆçº§é˜Ÿåˆ—éƒ½å‘é€å®Œæ¯•çš„æ—¶å€™ä¹Ÿä¼šå…³é—­å†™äº‹ä»¶ã€‚</p>
<h3 id="read">read</h3>
<p>ã€€ã€€å½“ epoll ä¸­çš„å¥—æ¥å­—å˜ä¸ºå¯è¯»ä»¥åï¼Œå¦‚æœæ˜¯ TCP è¿æ¥ï¼Œåˆ™ä½¿ç”¨ forward_message_tcp è¯»å–å¥—æ¥å­—ä¸­çš„æ•°æ®ã€‚<br>
ã€€ã€€æ¯æ¬¡è¯»å–çš„é•¿åº¦æ˜¯ socket.p.sizeï¼Œåˆå§‹ä¸º 64 å­—èŠ‚ï¼Œå¦‚æœåœ¨æœ¬æ¬¡è¯»å–çš„æ—¶å€™å‘ç°å¥—æ¥å­—ä¸­å¯è¯»é•¿åº¦å¤§äº size çš„è¯ï¼Œåˆ™å°† size æ‰©å¤§ä¸ºä¹‹å‰çš„ 2 å€ï¼Œå¦‚æœå‘ç°å¥—æ¥å­—ä¸­çš„æ•°æ®æ¯” size çš„ 1/2 è¿˜å°‘çš„æ—¶å€™ï¼Œåˆ™æŠŠ size å˜ä¸ºåŸæ¥çš„ 1/2 é•¿åº¦ã€‚å¦å¤–ï¼Œå¦‚æœæœ¬æ¬¡æ²¡æœ‰è¯»å–å®Œå¥—æ¥å­—ä¸­çš„æ•°æ®ï¼Œåˆ™ä¼šå‡å°‘ event_indexï¼Œä½¿ä¸‹ä¸€æ¬¡å¾ªç¯ä¾ç„¶å¤„ç†æœ¬äº‹ä»¶ã€‚<br>
ã€€ã€€è¯»å–åˆ°æ•°æ®ä»¥åï¼Œè½¬åŒ–æˆæ¶ˆæ¯ï¼Œç»™ socket çš„æºæœåŠ¡å‘é€ä¸€æ¡ SKYNET_SOCKET_TYPE_DATA ç±»å‹çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæ¶ˆæ¯ä¼šè§¦å‘ç½‘ç»œåˆ†åŒ…ï¼Œé€šè¿‡ netpack.filter è¿›è¡Œåˆ†åŒ…ï¼Œåˆ†åŒ…å€¼å¾—å•å¼€ä¸€ç¯‡æ–‡ç« ç»†è¯´ä¸€ä¸‹ï¼Œæ­¤å¤„å…ˆä¸€ç¬”å¸¦è¿‡ã€‚</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/skynet/">skynet</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/skynet-%E4%B8%8E-golang-%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E6%AF%94%E8%BE%83/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynet ä¸ golang å¹¶å‘æœºåˆ¶æ¯”è¾ƒ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E5%85%AB%E7%83%AD%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåå…«ï¼‰çƒ­æ›´æ–°æ“ä½œ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E4%B8%83sharetable%E7%9A%84%E5%AE%9E%E7%8E%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåä¸ƒï¼‰ShareTableçš„å®ç°</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E5%85%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåå…­ï¼‰å†…å­˜ç®¡ç†</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/skynet%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8D%81%E4%BA%94codecache%E7%9A%84%E5%AE%9E%E7%8E%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">skynetæºç åˆ†æï¼ˆåäº”ï¼‰CodeCacheçš„å®ç°</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="medetasi/homurua.github.io"
        issue-term="pathname"
        
        label="blog-comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2023 æ”¾å­¦åèŒ¶ä¼š
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.14.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#çº¿ç¨‹æ¨¡å‹">çº¿ç¨‹æ¨¡å‹</a></li>
    <li><a href="#socket-ç®¡ç†å™¨">socket ç®¡ç†å™¨</a>
      <ol>
        <li><a href="#ç»“æ„åˆ†æ">ç»“æ„åˆ†æ</a></li>
        <li><a href="#ç»“æ„åˆå§‹åŒ–">ç»“æ„åˆå§‹åŒ–</a></li>
        <li><a href="#epoll-ç›¸å…³">epoll ç›¸å…³</a></li>
        <li><a href="#self-pipe">self-pipe</a></li>
      </ol>
    </li>
    <li><a href="#socket-ç»“æ„ä½“">socket ç»“æ„ä½“</a>
      <ol>
        <li><a href="#ç»“æ„åˆ†æ-1">ç»“æ„åˆ†æ</a></li>
        <li><a href="#ä¸ºä»€ä¹ˆéœ€è¦-id">ä¸ºä»€ä¹ˆéœ€è¦ id</a></li>
      </ol>
    </li>
    <li><a href="#socket-çº¿ç¨‹">socket çº¿ç¨‹</a>
      <ol>
        <li><a href="#thread_socket">thread_socket</a></li>
        <li><a href="#skynet_socket_poll">skynet_socket_poll</a></li>
        <li><a href="#forward_message">forward_message</a></li>
        <li><a href="#socket_server_poll">socket_server_poll</a></li>
        <li><a href="#ç½‘ç»œæŒ‡ä»¤å¤„ç†">ç½‘ç»œæŒ‡ä»¤å¤„ç†</a></li>
      </ol>
    </li>
    <li><a href="#ç½‘ç»œè¯·æ±‚">ç½‘ç»œè¯·æ±‚</a>
      <ol>
        <li><a href="#æ¦‚è¿°">æ¦‚è¿°</a></li>
        <li><a href="#è¯·æ±‚åŒ…çš„ç»“æ„">è¯·æ±‚åŒ…çš„ç»“æ„</a></li>
        <li><a href="#å¤„ç†è¯·æ±‚åŒ…">å¤„ç†è¯·æ±‚åŒ…</a></li>
      </ol>
    </li>
    <li><a href="#ç½‘ç»œæ¥å£åˆ†æ">ç½‘ç»œæ¥å£åˆ†æ</a>
      <ol>
        <li><a href="#æ¦‚è¿°-1">æ¦‚è¿°</a></li>
        <li><a href="#connect">connect</a></li>
        <li><a href="#listen">listen</a></li>
        <li><a href="#accept">accept</a></li>
        <li><a href="#write">write</a></li>
        <li><a href="#read">read</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
